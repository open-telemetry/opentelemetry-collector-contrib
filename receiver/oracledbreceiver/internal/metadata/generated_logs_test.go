// Code generated by mdatagen. DO NOT EDIT.

package metadata

import (
	"context"
	"testing"
	"time"

	"github.com/stretchr/testify/assert"
	"go.opentelemetry.io/collector/pdata/pcommon"
	"go.opentelemetry.io/collector/pdata/plog"
	"go.opentelemetry.io/collector/receiver/receivertest"
	"go.opentelemetry.io/otel/trace"
	"go.uber.org/zap"
	"go.uber.org/zap/zaptest/observer"
)

type eventsTestDataSet int

const (
	eventTestDataSetDefault eventsTestDataSet = iota
	eventTestDataSetAll
	eventTestDataSetNone
)

func TestLogsBuilderAppendLogRecord(t *testing.T) {
	observedZapCore, _ := observer.New(zap.WarnLevel)
	settings := receivertest.NewNopSettings(receivertest.NopType)
	settings.Logger = zap.New(observedZapCore)
	lb := NewLogsBuilder(loadLogsBuilderConfig(t, "all_set"), settings)

	rb := lb.NewResourceBuilder()
	rb.SetHostName("host.name-val")
	rb.SetOracledbInstanceName("oracledb.instance.name-val")
	res := rb.Emit()

	// append the first log record
	lr := plog.NewLogRecord()
	lr.SetTimestamp(pcommon.NewTimestampFromTime(time.Now()))
	lr.Attributes().PutStr("type", "log")
	lr.Body().SetStr("the first log record")

	// append the second log record
	lr2 := plog.NewLogRecord()
	lr2.SetTimestamp(pcommon.NewTimestampFromTime(time.Now()))
	lr2.Attributes().PutStr("type", "event")
	lr2.Body().SetStr("the second log record")

	lb.AppendLogRecord(lr)
	lb.AppendLogRecord(lr2)

	logs := lb.Emit(WithLogsResource(res))
	assert.Equal(t, 1, logs.ResourceLogs().Len())

	rl := logs.ResourceLogs().At(0)
	assert.Equal(t, 1, rl.ScopeLogs().Len())

	sl := rl.ScopeLogs().At(0)
	assert.Equal(t, ScopeName, sl.Scope().Name())
	assert.Equal(t, lb.buildInfo.Version, sl.Scope().Version())

	assert.Equal(t, 2, sl.LogRecords().Len())

	attrVal, ok := sl.LogRecords().At(0).Attributes().Get("type")
	assert.True(t, ok)
	assert.Equal(t, "log", attrVal.Str())

	assert.Equal(t, pcommon.ValueTypeStr, sl.LogRecords().At(0).Body().Type())
	assert.Equal(t, "the first log record", sl.LogRecords().At(0).Body().Str())

	attrVal, ok = sl.LogRecords().At(1).Attributes().Get("type")
	assert.True(t, ok)
	assert.Equal(t, "event", attrVal.Str())

	assert.Equal(t, pcommon.ValueTypeStr, sl.LogRecords().At(1).Body().Type())
	assert.Equal(t, "the second log record", sl.LogRecords().At(1).Body().Str())
}
func TestLogsBuilder(t *testing.T) {
	tests := []struct {
		name        string
		eventsSet   eventsTestDataSet
		resAttrsSet eventsTestDataSet
		expectEmpty bool
	}{
		{
			name: "default",
		},
		{
			name:        "all_set",
			eventsSet:   eventTestDataSetAll,
			resAttrsSet: eventTestDataSetAll,
		},
		{
			name:        "none_set",
			eventsSet:   eventTestDataSetNone,
			resAttrsSet: eventTestDataSetNone,
			expectEmpty: true,
		},
		{
			name:        "filter_set_include",
			resAttrsSet: eventTestDataSetAll,
		},
		{
			name:        "filter_set_exclude",
			resAttrsSet: eventTestDataSetAll,
			expectEmpty: true,
		},
	}
	for _, tt := range tests {
		t.Run(tt.name, func(t *testing.T) {
			timestamp := pcommon.Timestamp(1_000_001_000)
			traceID := [16]byte{0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15}
			spanID := [8]byte{0, 1, 2, 3, 4, 5, 6, 7}
			ctx := trace.ContextWithSpanContext(context.Background(), trace.NewSpanContext(trace.SpanContextConfig{
				TraceID:    trace.TraceID(traceID),
				SpanID:     trace.SpanID(spanID),
				TraceFlags: trace.FlagsSampled,
			}))
			observedZapCore, observedLogs := observer.New(zap.WarnLevel)
			settings := receivertest.NewNopSettings(receivertest.NopType)
			settings.Logger = zap.New(observedZapCore)
			lb := NewLogsBuilder(loadLogsBuilderConfig(t, tt.name), settings)

			expectedWarnings := 0

			assert.Equal(t, expectedWarnings, observedLogs.Len())

			defaultEventsCount := 0
			allEventsCount := 0

			allEventsCount++
			lb.RecordDbServerQuerySampleEvent(ctx, timestamp, "db.query.text-val", "db.system.name-val", "user.name-val", "client.address-val", "oracledb.plan_hash_value-val", "oracledb.sql_id-val", "oracledb.child_number-val", "oracledb.sid-val", "oracledb.serial-val", "oracledb.process-val", "oracledb.schemaname-val", "oracledb.program-val", "oracledb.module-val", "oracledb.status-val", "oracledb.state-val", "oracledb.wait_class-val", "oracledb.event-val", "oracledb.object_name-val", "oracledb.object_type-val", "oracledb.osuser-val", 21.100000)

			allEventsCount++
			lb.RecordDbServerTopQueryEvent(ctx, timestamp, "db.system.name-val", "db.server.name-val", "db.query.text-val", "oracledb.query_plan-val", "oracledb.sql_id-val", "oracledb.child_number-val", 30.100000, 20, 26.100000, 30.100000, 17.100000, 21, 22, 19, 21.100000, 19, 28, 31, 29, 32, 23, 26.100000)

			rb := lb.NewResourceBuilder()
			rb.SetHostName("host.name-val")
			rb.SetOracledbInstanceName("oracledb.instance.name-val")
			res := rb.Emit()
			logs := lb.Emit(WithLogsResource(res))

			if tt.expectEmpty || ((tt.name == "default" || tt.name == "filter_set_include") && defaultEventsCount == 0) {
				assert.Equal(t, 0, logs.ResourceLogs().Len())
				return
			}

			assert.Equal(t, 1, logs.ResourceLogs().Len())
			rl := logs.ResourceLogs().At(0)
			assert.Equal(t, res, rl.Resource())
			assert.Equal(t, 1, rl.ScopeLogs().Len())
			lrs := rl.ScopeLogs().At(0).LogRecords()
			if tt.eventsSet == eventTestDataSetDefault {
				assert.Equal(t, defaultEventsCount, lrs.Len())
			}
			if tt.eventsSet == eventTestDataSetAll {
				assert.Equal(t, allEventsCount, lrs.Len())
			}
			validatedEvents := make(map[string]bool)
			for i := 0; i < lrs.Len(); i++ {
				switch lrs.At(i).EventName() {
				case "db.server.query_sample":
					assert.False(t, validatedEvents["db.server.query_sample"], "Found a duplicate in the events slice: db.server.query_sample")
					validatedEvents["db.server.query_sample"] = true
					lr := lrs.At(i)
					assert.Equal(t, timestamp, lr.Timestamp())
					assert.Equal(t, pcommon.TraceID(traceID), lr.TraceID())
					assert.Equal(t, pcommon.SpanID(spanID), lr.SpanID())
					attrVal, ok := lr.Attributes().Get("db.query.text")
					assert.True(t, ok)
					assert.Equal(t, "db.query.text-val", attrVal.Str())
					attrVal, ok = lr.Attributes().Get("db.system.name")
					assert.True(t, ok)
					assert.Equal(t, "db.system.name-val", attrVal.Str())
					attrVal, ok = lr.Attributes().Get("user.name")
					assert.True(t, ok)
					assert.Equal(t, "user.name-val", attrVal.Str())
					attrVal, ok = lr.Attributes().Get("client.address")
					assert.True(t, ok)
					assert.Equal(t, "client.address-val", attrVal.Str())
					attrVal, ok = lr.Attributes().Get("oracledb.plan_hash_value")
					assert.True(t, ok)
					assert.Equal(t, "oracledb.plan_hash_value-val", attrVal.Str())
					attrVal, ok = lr.Attributes().Get("oracledb.sql_id")
					assert.True(t, ok)
					assert.Equal(t, "oracledb.sql_id-val", attrVal.Str())
					attrVal, ok = lr.Attributes().Get("oracledb.child_number")
					assert.True(t, ok)
					assert.Equal(t, "oracledb.child_number-val", attrVal.Str())
					attrVal, ok = lr.Attributes().Get("oracledb.sid")
					assert.True(t, ok)
					assert.Equal(t, "oracledb.sid-val", attrVal.Str())
					attrVal, ok = lr.Attributes().Get("oracledb.serial")
					assert.True(t, ok)
					assert.Equal(t, "oracledb.serial-val", attrVal.Str())
					attrVal, ok = lr.Attributes().Get("oracledb.process")
					assert.True(t, ok)
					assert.Equal(t, "oracledb.process-val", attrVal.Str())
					attrVal, ok = lr.Attributes().Get("oracledb.schemaname")
					assert.True(t, ok)
					assert.Equal(t, "oracledb.schemaname-val", attrVal.Str())
					attrVal, ok = lr.Attributes().Get("oracledb.program")
					assert.True(t, ok)
					assert.Equal(t, "oracledb.program-val", attrVal.Str())
					attrVal, ok = lr.Attributes().Get("oracledb.module")
					assert.True(t, ok)
					assert.Equal(t, "oracledb.module-val", attrVal.Str())
					attrVal, ok = lr.Attributes().Get("oracledb.status")
					assert.True(t, ok)
					assert.Equal(t, "oracledb.status-val", attrVal.Str())
					attrVal, ok = lr.Attributes().Get("oracledb.state")
					assert.True(t, ok)
					assert.Equal(t, "oracledb.state-val", attrVal.Str())
					attrVal, ok = lr.Attributes().Get("oracledb.wait_class")
					assert.True(t, ok)
					assert.Equal(t, "oracledb.wait_class-val", attrVal.Str())
					attrVal, ok = lr.Attributes().Get("oracledb.event")
					assert.True(t, ok)
					assert.Equal(t, "oracledb.event-val", attrVal.Str())
					attrVal, ok = lr.Attributes().Get("oracledb.object_name")
					assert.True(t, ok)
					assert.Equal(t, "oracledb.object_name-val", attrVal.Str())
					attrVal, ok = lr.Attributes().Get("oracledb.object_type")
					assert.True(t, ok)
					assert.Equal(t, "oracledb.object_type-val", attrVal.Str())
					attrVal, ok = lr.Attributes().Get("oracledb.osuser")
					assert.True(t, ok)
					assert.Equal(t, "oracledb.osuser-val", attrVal.Str())
					attrVal, ok = lr.Attributes().Get("oracledb.duration_sec")
					assert.True(t, ok)
					assert.Equal(t, 21.100000, attrVal.Double())
				case "db.server.top_query":
					assert.False(t, validatedEvents["db.server.top_query"], "Found a duplicate in the events slice: db.server.top_query")
					validatedEvents["db.server.top_query"] = true
					lr := lrs.At(i)
					assert.Equal(t, timestamp, lr.Timestamp())
					assert.Equal(t, pcommon.TraceID(traceID), lr.TraceID())
					assert.Equal(t, pcommon.SpanID(spanID), lr.SpanID())
					attrVal, ok := lr.Attributes().Get("db.system.name")
					assert.True(t, ok)
					assert.Equal(t, "db.system.name-val", attrVal.Str())
					attrVal, ok = lr.Attributes().Get("db.server.name")
					assert.True(t, ok)
					assert.Equal(t, "db.server.name-val", attrVal.Str())
					attrVal, ok = lr.Attributes().Get("db.query.text")
					assert.True(t, ok)
					assert.Equal(t, "db.query.text-val", attrVal.Str())
					attrVal, ok = lr.Attributes().Get("oracledb.query_plan")
					assert.True(t, ok)
					assert.Equal(t, "oracledb.query_plan-val", attrVal.Str())
					attrVal, ok = lr.Attributes().Get("oracledb.sql_id")
					assert.True(t, ok)
					assert.Equal(t, "oracledb.sql_id-val", attrVal.Str())
					attrVal, ok = lr.Attributes().Get("oracledb.child_number")
					assert.True(t, ok)
					assert.Equal(t, "oracledb.child_number-val", attrVal.Str())
					attrVal, ok = lr.Attributes().Get("oracledb.application_wait_time")
					assert.True(t, ok)
					assert.Equal(t, 30.100000, attrVal.Double())
					attrVal, ok = lr.Attributes().Get("oracledb.buffer_gets")
					assert.True(t, ok)
					assert.EqualValues(t, 20, attrVal.Int())
					attrVal, ok = lr.Attributes().Get("oracledb.cluster_wait_time")
					assert.True(t, ok)
					assert.Equal(t, 26.100000, attrVal.Double())
					attrVal, ok = lr.Attributes().Get("oracledb.concurrency_wait_time")
					assert.True(t, ok)
					assert.Equal(t, 30.100000, attrVal.Double())
					attrVal, ok = lr.Attributes().Get("oracledb.cpu_time")
					assert.True(t, ok)
					assert.Equal(t, 17.100000, attrVal.Double())
					attrVal, ok = lr.Attributes().Get("oracledb.direct_reads")
					assert.True(t, ok)
					assert.EqualValues(t, 21, attrVal.Int())
					attrVal, ok = lr.Attributes().Get("oracledb.direct_writes")
					assert.True(t, ok)
					assert.EqualValues(t, 22, attrVal.Int())
					attrVal, ok = lr.Attributes().Get("oracledb.disk_reads")
					assert.True(t, ok)
					assert.EqualValues(t, 19, attrVal.Int())
					attrVal, ok = lr.Attributes().Get("oracledb.elapsed_time")
					assert.True(t, ok)
					assert.Equal(t, 21.100000, attrVal.Double())
					attrVal, ok = lr.Attributes().Get("oracledb.executions")
					assert.True(t, ok)
					assert.EqualValues(t, 19, attrVal.Int())
					attrVal, ok = lr.Attributes().Get("oracledb.physical_read_bytes")
					assert.True(t, ok)
					assert.EqualValues(t, 28, attrVal.Int())
					attrVal, ok = lr.Attributes().Get("oracledb.physical_read_requests")
					assert.True(t, ok)
					assert.EqualValues(t, 31, attrVal.Int())
					attrVal, ok = lr.Attributes().Get("oracledb.physical_write_bytes")
					assert.True(t, ok)
					assert.EqualValues(t, 29, attrVal.Int())
					attrVal, ok = lr.Attributes().Get("oracledb.physical_write_requests")
					assert.True(t, ok)
					assert.EqualValues(t, 32, attrVal.Int())
					attrVal, ok = lr.Attributes().Get("oracledb.rows_processed")
					assert.True(t, ok)
					assert.EqualValues(t, 23, attrVal.Int())
					attrVal, ok = lr.Attributes().Get("oracledb.user_io_wait_time")
					assert.True(t, ok)
					assert.Equal(t, 26.100000, attrVal.Double())
				}
			}
		})
	}
}
