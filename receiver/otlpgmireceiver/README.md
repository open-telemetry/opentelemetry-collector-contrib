# OTLPGMI Receiver

<!-- status autogenerated section -->
| Status        |           |
| ------------- |-----------|
| Stability     | [development]: profiles   |
|               | [stable]: traces, metrics, logs   |
| Distributions | [core], [contrib], [k8s], [otlp] |
| Issues        | [![Open issues](https://img.shields.io/github/issues-search/open-telemetry/opentelemetry-collector?query=is%3Aissue%20is%3Aopen%20label%3Areceiver%2Fotlp%20&label=open&color=orange&logo=opentelemetry)](https://github.com/open-telemetry/opentelemetry-collector/issues?q=is%3Aopen+is%3Aissue+label%3Areceiver%2Fotlp) [![Closed issues](https://img.shields.io/github/issues-search/open-telemetry/opentelemetry-collector?query=is%3Aissue%20is%3Aclosed%20label%3Areceiver%2Fotlp%20&label=closed&color=blue&logo=opentelemetry)](https://github.com/open-telemetry/opentelemetry-collector/issues?q=is%3Aclosed+is%3Aissue+label%3Areceiver%2Fotlp) |

[development]: https://github.com/open-telemetry/opentelemetry-collector/blob/main/docs/component-stability.md#development
[stable]: https://github.com/open-telemetry/opentelemetry-collector/blob/main/docs/component-stability.md#stable
[core]: https://github.com/open-telemetry/opentelemetry-collector-releases/tree/main/distributions/otelcol
[contrib]: https://github.com/open-telemetry/opentelemetry-collector-releases/tree/main/distributions/otelcol-contrib
[k8s]: https://github.com/open-telemetry/opentelemetry-collector-releases/tree/main/distributions/otelcol-k8s
[otlp]: https://github.com/open-telemetry/opentelemetry-collector-releases/tree/main/distributions/otelcol-otlp
<!-- end autogenerated section -->

Receives data via gRPC or HTTP using [OTLP](
https://github.com/open-telemetry/opentelemetry-specification/blob/main/specification/protocol/otlp.md)
format.

## Getting Started

All that is required to enable the OTLPGMI receiver is to include it in the
receiver definitions. A protocol can be disabled by simply not specifying it in
the list of protocols.

```yaml
receivers:
  otlpgmi:
    protocols:
      grpc:
      http:
```

## License Validation

The OTLPGMI receiver supports license validation for HTTP endpoints. When license validation is enabled, clients must include their license key in the URL path.

### Configuration

```yaml
receivers:
  otlpgmi:
    protocols:
      http:
        endpoint: localhost:4318
    license:
      validation_url: https://license.example.com/api/validate
      cache_timeout: 3600  # Cache validation results for 1 hour
```

### Client Usage

When license validation is enabled, clients must send data to URLs that include their license key as the first path segment:

- **Traces**: `POST http://localhost:4318/{licenseKey}/v1/traces`
- **Metrics**: `POST http://localhost:4318/{licenseKey}/v1/metrics`
- **Logs**: `POST http://localhost:4318/{licenseKey}/v1/logs`
- **Profiles**: `POST http://localhost:4318/{licenseKey}/v1/profiles`

The receiver will:
1. Extract the license key from the URL path
2. Check cache for existing validation result and user information
3. If not cached or expired, send a validation request to the configured `validation_url` with the license key as a query parameter
4. Parse user information from the validation response (user_id, username, email, company, plan, etc.)
5. Cache both validation result and user information for the configured `cache_timeout` period
6. Add user information as metadata to the telemetry data:
   - **Traces**: Added to resource attributes (user.id, user.name, user.email, etc.)
   - **Metrics**: Added to resource attributes (user.id, user.name, user.email, etc.)
   - **Logs**: Added to resource attributes (user.id, user.name, user.email, etc.)
   - **Profiles**: Added to resource attributes (user.id, user.name, user.email, etc.)
7. Allow or deny the request based on the validation result

### License Validation Response

The validation service should return a JSON response with user information:

```json
{
  "user_id": "user123",
  "username": "john.doe",
  "email": "john@example.com",
  "company": "Acme Corp",
  "plan": "enterprise",
  "expires_at": 1640995200,
  "metadata": {
    "region": "us-west",
    "tier": "premium"
  }
}
```

- **Valid License**: Returns 200 OK with user info, processes the OTLP data with user metadata
- **Invalid License**: Returns 403 Forbidden with error message

### User Information Injection

The receiver automatically injects user information into all telemetry data as resource attributes:

**Standard User Attributes:**
- `user.id` - User ID from validation response
- `user.name` - Username from validation response  
- `user.email` - Email address from validation response
- `user.company` - Company name from validation response
- `user.plan` - License plan from validation response
- `user.expires_at` - License expiration timestamp

**Custom Metadata:**
- `user.metadata.{key}` - Custom metadata fields from validation response

**Example Resource Attributes:**
```
user.id: "user123"
user.name: "john.doe"
user.email: "john@example.com"
user.company: "Acme Corp"
user.plan: "enterprise"
user.expires_at: 1640995200
user.metadata.region: "us-west"
user.metadata.tier: "premium"
```

### Caching

The receiver implements intelligent caching to avoid frequent validation requests:
- License validation results and user information are cached in memory
- Cache duration is configurable via `cache_timeout` (default: 3600 seconds)
- Cache is thread-safe and supports concurrent requests
- Expired cache entries are automatically cleaned up

The following settings are configurable:

- `endpoint` (default = localhost:4317 for grpc protocol, localhost:4318 http protocol):
  host:port to which the receiver is going to receive data. The valid syntax is
  described at https://github.com/grpc/grpc/blob/master/doc/naming.md. See our 
  [security best practices doc](https://opentelemetry.io/docs/security/config-best-practices/#protect-against-denial-of-service-attacks)
  to understand how to set the endpoint in different environments.

## Advanced Configuration

Several helper files are leveraged to provide additional capabilities automatically:

- [gRPC settings](https://github.com/open-telemetry/opentelemetry-collector/blob/main/config/configgrpc/README.md) including CORS
- [HTTP settings](https://github.com/open-telemetry/opentelemetry-collector/blob/main/config/confighttp/README.md)
- [TLS and mTLS settings](https://github.com/open-telemetry/opentelemetry-collector/blob/main/config/configtls/README.md)
- [Auth settings](https://github.com/open-telemetry/opentelemetry-collector/blob/main/config/configauth/README.md)

## Writing with HTTP/JSON

The OTLPGMI receiver can receive trace export calls via HTTP/JSON in addition to
gRPC. The HTTP/JSON address is the same as gRPC as the protocol is recognized
and processed accordingly. Note the serialization format needs to be [OTLP JSON](https://opentelemetry.io/docs/specs/otlp/#json-protobuf-encoding).

The HTTP/JSON configuration also provides `traces_url_path`,
`metrics_url_path`, `logs_url_path`, and `profiles_url_path` configurations to
allow the URL paths that signal data needs to be sent to be modified per signal
type.  These default to `/v1/traces`, `/v1/metrics`, `/v1/logs`, and
`/v1/profiles` respectively.

To write traces with HTTP/JSON, `POST` to `[address]/[traces_url_path]` for
traces, to `[address]/[metrics_url_path]` for metrics, to
`[address]/[logs_url_path]` for logs, and to `[address]/[profiles_url_path]` for
profiles.
The default port is `4318`.  When using the `otlphttpexporter` peer to
communicate with this component, use the `traces_endpoint`,
`metrics_endpoint`, `logs_endpoint`, and `profiles_endpoint` settings in the
`otlphttpexporter` to set the proper URL to match the address and URL signal
path on the `otlpgmireceiver`.

### CORS (Cross-origin resource sharing)

The HTTP/JSON endpoint can also optionally configure [CORS][cors] under `cors:`.
Specify what origins (or wildcard patterns) to allow requests from as
`allowed_origins`. To allow additional request headers outside of the [default
safelist][cors-headers], set `allowed_headers`. Browsers can be instructed to
[cache][cors-max-age] responses to preflight requests by setting `max_age`.

[cors]: https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS
[cors-headers]: https://developer.mozilla.org/en-US/docs/Glossary/CORS-safelisted_request_header
[cors-max-age]: https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Access-Control-Max-Age

```yaml
receivers:
  otlpgmi:
    protocols:
      http:
        endpoint: "localhost:4318"
        cors:
          allowed_origins:
            - http://test.com
            # Origins can have wildcards with *, use * by itself to match any origin.
            - https://*.example.com
          allowed_headers:
            - Example-Header
          max_age: 7200
```

[contrib]: https://github.com/open-telemetry/opentelemetry-collector-releases/tree/main/distributions/otelcol-contrib
[core]: https://github.com/open-telemetry/opentelemetry-collector-releases/tree/main/distributions/otelcol
