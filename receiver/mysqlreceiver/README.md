# MySQL Receiver

<!-- status autogenerated section -->
| Status        |           |
| ------------- |-----------|
| Stability     | [development]: logs   |
|               | [beta]: metrics   |
| Distributions | [contrib] |
| Issues        | [![Open issues](https://img.shields.io/github/issues-search/open-telemetry/opentelemetry-collector-contrib?query=is%3Aissue%20is%3Aopen%20label%3Areceiver%2Fmysql%20&label=open&color=orange&logo=opentelemetry)](https://github.com/open-telemetry/opentelemetry-collector-contrib/issues?q=is%3Aopen+is%3Aissue+label%3Areceiver%2Fmysql) [![Closed issues](https://img.shields.io/github/issues-search/open-telemetry/opentelemetry-collector-contrib?query=is%3Aissue%20is%3Aclosed%20label%3Areceiver%2Fmysql%20&label=closed&color=blue&logo=opentelemetry)](https://github.com/open-telemetry/opentelemetry-collector-contrib/issues?q=is%3Aclosed+is%3Aissue+label%3Areceiver%2Fmysql) |
| Code coverage | [![codecov](https://codecov.io/github/open-telemetry/opentelemetry-collector-contrib/graph/main/badge.svg?component=receiver_mysql)](https://app.codecov.io/gh/open-telemetry/opentelemetry-collector-contrib/tree/main/?components%5B0%5D=receiver_mysql&displayType=list) |
| [Code Owners](https://github.com/open-telemetry/opentelemetry-collector-contrib/blob/main/CONTRIBUTING.md#becoming-a-code-owner)    | [@antonblock](https://www.github.com/antonblock), [@ishleenk17](https://www.github.com/ishleenk17) \| Seeking more code owners! |
| Emeritus      | [@djaglowski](https://www.github.com/djaglowski) |

[development]: https://github.com/open-telemetry/opentelemetry-collector/blob/main/docs/component-stability.md#development
[beta]: https://github.com/open-telemetry/opentelemetry-collector/blob/main/docs/component-stability.md#beta
[contrib]: https://github.com/open-telemetry/opentelemetry-collector-releases/tree/main/distributions/otelcol-contrib
<!-- end autogenerated section -->

This receiver queries MySQL's global status and InnoDB tables.

Some metrics will not appear if their corresponding feature is inactive.  
There are also optional metrics that you must specify in your configuration to collect,  listed in [documentation.md](./documentation.md) 

## Prerequisites

This receiver supports MySQL version 8.0 and MariaDB 10.11.

Collecting most metrics requires the ability to execute `SHOW GLOBAL STATUS`.

Collecting query samples requires the `performance_schema` to be enabled:
```
GRANT SELECT ON performance_schema.* TO <your-user>@'%';
```

## Configuration


The following settings are optional:
- `endpoint`: (default = `localhost:3306`)
- `tls`: Defines the TLS configuration to use. If `tls` is not set, the default is to disable TLS connections.
  - `insecure`: (default = `false`) Set this to `true` to disable TLS connections.
  - `insecure_skip_verify`: (default = `false`) Set this to `true` to enable TLS but not verify the certificate.
  - `server_name_override`: This sets the ServerName in the TLSConfig.  
- `username`: (default = `root`)
- `password`: The password to the username.
- `allow_native_passwords`: (default = `true`)
- `database`: The database name. If not specified, metrics will be collected for all databases.

- `collection_interval` (default = `10s`): This receiver collects metrics on an interval. This value must be a string readable by Golang's [time.ParseDuration](https://pkg.go.dev/time#ParseDuration). Valid time units are `ns`, `us` (or `Âµs`), `ms`, `s`, `m`, `h`.
- `initial_delay` (default = `1s`): defines how long this receiver waits before starting.

- `transport`: (default = `tcp`): Defines the network to use for connecting to the server.
- `statement_events`: Additional configuration for query to build `mysql.statement_events.count` and `mysql.statement_events.wait.time` metrics:
  - `digest_text_limit` - maximum length of `digest_text`. Longer text will be truncated (default=`120`)
  - `time_limit` - maximum time from since the statements have been observed last time (default=`24h`)
  - `limit` - limit of records, which is maximum number of generated metrics (default=`250`)
- `query_sample_collection`: Additional configuration for query sample collection(`db.server.query_sample` event):
  - `max_rows_per_query` - maximum number of rows to collect per scrape (default=`100`)
- `top_query_collection`: Additional configuration for top queries collection (`db.server.top_query` event):
  - `lookback_time` (optional, example = `60`, default = `2 * collection_interval`): The time window (in seconds) in which to query for top queries.
    - Queries that finished execution outside the lookback window are not included in the collection. Increasing the lookback window will be useful for capturing long-running queries.
  - `max_query_sample_count` (optional, example = `5000`, default = `1000`): The maximum number of records to fetch in a single run.
  - `top_query_count`: (optional, example = `100`, default = `200`): The maximum number of active queries to report (to the next consumer) in a single run.
  - `collection_interval`: (optional, default = `60s`): The interval at which top queries should be emitted by this receiver.
    - This value can only guarantee that the top queries are collected at most once in this interval.
      - For instance, you have global `collection_interval` set to `10s` and `top_query_collection.collection_interval` set to `60s`.
        - In this case, the default receiver scraper will still run every 10 seconds.
        - However, the top queries collection will only run after 60 seconds have passed since the last collection.
      - For instance, you have global `collection_interval` set to `10s` and `top_query_collection.collection_interval` set to `5s`.
        - In this case, `top_query_collection.collection_interval` will have no impact on the collection frequency, which will run every 10s.
  - `query_plan_cache_size`: (optional, default = `1000`). The query plan cache size. Once we got query plan results from explain queries, we will store them in the cache.
    This defines the cache's size for query plan.
  - `query_plan_cache_ttl`: (optional, example = `1m`, default = `1h`). How long until a query plan expires in the cache. The receiver will run an explain query to MySQL to get the query plan after it expires.

### Example Configuration

```yaml
receivers:
  mysql:
    endpoint: localhost:3306
    username: otel
    password: ${env:MYSQL_PASSWORD}
    database: otel
    collection_interval: 10s
    initial_delay: 1s
    statement_events:
      digest_text_limit: 120
      time_limit: 24h
      limit: 250
```

The full list of settings exposed for this receiver are documented in [config.go](./config.go) with detailed sample configurations in [testdata/config.yaml](./testdata/config.yaml).

## Metrics

Details about the metrics produced by this receiver can be found in [metadata.yaml](./metadata.yaml)

## Logs
Details about the logs produced by this receiver can be found in [documentation.md](./documentation.md)

### MySQL Requirements to enable log collection

| Parameter                                | Value                            | Description                                         |
|------------------------------------------|----------------------------------|-----------------------------------------------------|
| `performance_schema`                     | Enabled (Required)               | Enable performance schema                           |
| `max_digest_length`                      | `4096`  (Recommended)            | Maximum length of digest text                       |
| `performance_schema_max_digest_length`   | `4096`  (Recommended)            | Maximum length of digest text on performance schema |
| `performance_schema_max_sql_text_length` | `4096`  (Recommended)            | Maximum length of sql text                          |
