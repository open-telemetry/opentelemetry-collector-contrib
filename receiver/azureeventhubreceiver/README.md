# Azure Event Hub Receiver

<!-- status autogenerated section -->
| Status        |           |
| ------------- |-----------|
| Stability     | [alpha]: metrics, logs, traces   |
| Distributions | [contrib] |
| Issues        | [![Open issues](https://img.shields.io/github/issues-search/open-telemetry/opentelemetry-collector-contrib?query=is%3Aissue%20is%3Aopen%20label%3Areceiver%2Fazureeventhub%20&label=open&color=orange&logo=opentelemetry)](https://github.com/open-telemetry/opentelemetry-collector-contrib/issues?q=is%3Aopen+is%3Aissue+label%3Areceiver%2Fazureeventhub) [![Closed issues](https://img.shields.io/github/issues-search/open-telemetry/opentelemetry-collector-contrib?query=is%3Aissue%20is%3Aclosed%20label%3Areceiver%2Fazureeventhub%20&label=closed&color=blue&logo=opentelemetry)](https://github.com/open-telemetry/opentelemetry-collector-contrib/issues?q=is%3Aclosed+is%3Aissue+label%3Areceiver%2Fazureeventhub) |
| Code coverage | [![codecov](https://codecov.io/github/open-telemetry/opentelemetry-collector-contrib/graph/main/badge.svg?component=receiver_azureeventhub)](https://app.codecov.io/gh/open-telemetry/opentelemetry-collector-contrib/tree/main/?components%5B0%5D=receiver_azureeventhub&displayType=list) |
| [Code Owners](https://github.com/open-telemetry/opentelemetry-collector-contrib/blob/main/CONTRIBUTING.md#becoming-a-code-owner)    | [@atoulme](https://www.github.com/atoulme), [@cparkins](https://www.github.com/cparkins), [@dyl10s](https://www.github.com/dyl10s) \| Seeking more code owners! |
| Emeritus      | [@djaglowski](https://www.github.com/djaglowski) |

[alpha]: https://github.com/open-telemetry/opentelemetry-collector/blob/main/docs/component-stability.md#alpha
[contrib]: https://github.com/open-telemetry/opentelemetry-collector-releases/tree/main/distributions/otelcol-contrib
<!-- end autogenerated section -->

## Overview

Azure resources and services can be
[configured](https://learn.microsoft.com/en-us/azure/azure-monitor/essentials/diagnostic-settings)
to send their telemetry to an Azure Event Hub. The Azure Event Hub receiver pulls telemetry from an Azure
Event Hub, transforms them, and pushes them through the collector pipeline.

### Read further

* [Diagnostic settings in Azure Monitor](https://learn.microsoft.com/en-us/azure/azure-monitor/platform/diagnostic-settings?tabs=portal)
* [Stream Azure monitoring data to an event hub and external partner](https://learn.microsoft.com/en-us/azure/azure-monitor/platform/stream-monitoring-data-event-hubs)

## Configuration

### connection (Required)
A string describing the connection to an Azure event hub.

### group (Optional)
The Consumer Group to read from. If empty will default to the default Consumer Group $Default

### partition (Optional)
The partition to watch. If empty, it will watch explicitly all partitions.

Default: ""

### offset (Optional)
The offset at which to start watching the event hub. If empty, it starts with the latest offset.
Only applicable when `partition` is set.

Default: ""

### format (Optional)
Determines how to transform the Event Hub messages into OpenTelemetry logs. See the "Format"
section below for details.

Default: "azure"

### apply_semantic_conventions (optional)
Determines whether Azure Resource Logs are translated into OpenTelemetry Logs using semantic
convention attribute names or not. When not applying semantic conventions, the log entry
attribute names are copied without any changes.

Default: `false` (semantic conventions are not applied)

### time_formats (optional)

All supported time format for logs, metrics and traces. Default is `nil` (unset), which means using the current iso8601 parser. The format is based on https://pkg.go.dev/time#Layout. If no time-zone info, will use UTC time. If all failed, it will use iso8601 format to parse.

Default: `nil`

### metric_aggregation (optional)

Metric records received from an Azure Event Hub will contain multiple aggregated datapoints. Depending on the
[type of metric](https://learn.microsoft.com/en-us/azure/azure-monitor/metrics/data-platform-metrics#types-of-metrics),
these datapoints will be slightly different, but all contain a total/sum, min, max and count. This setting will manage
these datapoints.

#### Possible values:

* By default, these datapoints will be mapped to metrics named with a corresponding suffix, like `_total`, `_min`, etc.
  See [azure format](#azure).
* With `average`, datapoints will be aggregated into an average value (`sum/count`), and keep the original metric name.

Default: `nil`

> [!NOTE]
> You can opt-in to use the [`azeventhubs`](https://github.com/Azure/azure-sdk-for-go/blob/main/sdk/messaging/azeventhubs) sdk by enabling the feature gate
> `receiver.azureeventhubreceiver.UseAzeventhubs` when you run the OpenTelemetry Collector. See the following page
> for more details: [Feature Gates](https://github.com/open-telemetry/opentelemetry-collector/tree/main/featuregate#controlling-gates)
>
> The following configuration options can only be used with this feature flag enabled

### max_poll_events (optional)
Specifies the maximum number of events to retrieve in a single poll from the Event Hub.

Default: `100`

### poll_rate (optional)
Specifies the maximum number of seconds to wait for additional events before returning fewer than `max_poll_events`.

Default: `5`

### Example Configuration

```yaml
receivers:
  azureeventhub:
    connection: Endpoint=sb://namespace.servicebus.windows.net/;SharedAccessKeyName=RootManageSharedAccessKey;SharedAccessKey=superSecret1234=;EntityPath=hubName
    partition: foo
    group: bar
    offset: "1234-5566"
    format: "azure"
    # optional
    time_formats:
      # All supported time format. Default is empty string array, which means using the current iso8601 parser. The format is based on https://pkg.go.dev/time#Layout. If no time-zone info, will use UTC time.
      logs: ["01/02/2006 15:04:05","2006-01-02 15:04:05","2006-01-02T15:04:05Z07:00"]
      metrics: ["01/02/2006 15:04:05"]
```

This component can persist its state using the [storage extension].

## Format

### raw

The "raw" format maps the AMQP properties and data into the
attributes and body of an OpenTelemetry LogRecord, respectively.
The body is represented as a raw byte array.

> [!WARN]
> This format is not supported for Metrics.

### azure

#### Logs

The "azure" format extracts the Azure log records from the AMQP
message data, parses them, and maps the fields to OpenTelemetry
attributes. The table below summarizes the mapping between the 
[Azure common log format](https://learn.microsoft.com/en-us/azure/azure-monitor/essentials/resource-logs-schema)
and the OpenTelemetry attributes.


| Azure                            | OpenTelemetry                          | 
|----------------------------------|----------------------------------------|
| callerIpAddress (optional)       | net.sock.peer.addr (attribute)         | 
| correlationId (optional)         | azure.correlation.id (attribute)       | 
| category (optional)              | azure.category (attribute)             | 
| durationMs (optional)            | azure.duration (attribute)             | 
| Level (optional)                 | severity_number, severity_text (field) | 
| location (optional)              | cloud.region (attribute)               | 
| â€”                                | cloud.provider (attribute)             | 
| operationName (required)         | azure.operation.name (attribute)       |
| operationVersion (optional)      | azure.operation.version (attribute)    | 
| properties (optional)            | azure.properties (attribute, nested)   | 
| resourceId (required)            | azure.resource.id (resource attribute) | 
| resultDescription (optional)     | azure.result.description (attribute)   | 
| resultSignature (optional)       | azure.result.signature (attribute)     | 
| resultType (optional)            | azure.result.type (attribute)          | 
| tenantId (required, tenant logs) | azure.tenant.id (attribute)            | 
| time or timeStamp (required)     | time_unix_nano (time takes precedence) |
| identity (optional)              | azure.identity (attribute, nested)     |

Notes:
* JSON does not distinguish between fixed and floating point numbers. All
JSON numbers are encoded as doubles.

#### Metrics

For Metrics the Azure Metric Records are an array
of "records" with the following fields, by
[type of metric](https://learn.microsoft.com/en-us/azure/azure-monitor/metrics/data-platform-metrics#types-of-metrics).

From this data a Metric of type Gauge is created
with a Data Points that represents the values
for the Metric including: Total, Minimum, Maximum,
Average and Count.

##### Platform metric (from Azure resources)

| Azure      | Open Telemetry                              |
|------------|---------------------------------------------|
| time       | time_unix_nano (field)                      |
| resourceId | azure.resource.id (resource attribute)      |
| metricName |                                             |
| timeGrain  | start_time_unix_nano (field)                |
| total      | mapped to datapoint metricName + "_TOTAL"   |
| count      | mapped to datapoint metricName + "_COUNT"   |
| minimum    | mapped to datapoint metricName + "_MINIMUM" |
| maximum    | mapped to datapoint metricName + "_MAXIMUM" |
| average    | mapped to datapoint metricName + "_AVERAGE" |

##### Application metrics (from Application Insights)

See: https://learn.microsoft.com/en-us/azure/azure-monitor/reference/tables/appmetrics

| Azure                      | Open Telemetry                              |
|----------------------------|---------------------------------------------|
| time                       | time_unix_nano (field)                      |
| resourceId                 | azure.resource.id (resource attribute)      |
| Name                       | (metric name)                               |
| AppRoleInstance            | service.instance.id (resource attribute)    |
| AppRoleName                | service.name (resource attribute)           |
| AppVersion                 | service.version (resource attribute)        |
| SDKVersion                 | telemetry.sdk.version (resource attribute)  |
| ClientCountryOrRegion      | cloud.region (resource attribute)           |
| ClientOS                   | os.name (resource attribute)                |
| Properties (key/value map) | mapped to resource attributes               |
| Sum                        | mapped to datapoint metricName + "_TOTAL"   |
| ItemCount                  | mapped to datapoint metricName + "_COUNT"   |
| Min                        | mapped to datapoint metricName + "_MINIMUM" |
| Max                        | mapped to datapoint metricName + "_MAXIMUM" |

#### Traces

Traces based on Azure Application Insights array of records from `AppRequests` & `AppDependencies` with the following fields.

| Azure       | Open Telemetry                                        |
|-------------|-------------------------------------------------------|
| Time        | start_time(time_unix_nano(time))                      |
|             | end_time(start_time + time_unix_nano(durationMs))     |
| Name        | span.name                                             |
| OperationId | trace.id                                              |
| ParentId    | span.parentId                                         |
| Id          | span.id                                               |
| AppRoleName | service.name                                          |

[storage extension]: https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/extension/storage
