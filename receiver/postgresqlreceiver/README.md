# PostgreSQL Receiver

<!-- status autogenerated section -->
| Status        |           |
| ------------- |-----------|
| Stability     | [development]: logs   |
|               | [beta]: metrics   |
| Distributions | [contrib] |
| Issues        | [![Open issues](https://img.shields.io/github/issues-search/open-telemetry/opentelemetry-collector-contrib?query=is%3Aissue%20is%3Aopen%20label%3Areceiver%2Fpostgresql%20&label=open&color=orange&logo=opentelemetry)](https://github.com/open-telemetry/opentelemetry-collector-contrib/issues?q=is%3Aopen+is%3Aissue+label%3Areceiver%2Fpostgresql) [![Closed issues](https://img.shields.io/github/issues-search/open-telemetry/opentelemetry-collector-contrib?query=is%3Aissue%20is%3Aclosed%20label%3Areceiver%2Fpostgresql%20&label=closed&color=blue&logo=opentelemetry)](https://github.com/open-telemetry/opentelemetry-collector-contrib/issues?q=is%3Aclosed+is%3Aissue+label%3Areceiver%2Fpostgresql) |
| Code coverage | [![codecov](https://codecov.io/github/open-telemetry/opentelemetry-collector-contrib/graph/main/badge.svg?component=receiver_postgresql)](https://app.codecov.io/gh/open-telemetry/opentelemetry-collector-contrib/tree/main/?components%5B0%5D=receiver_postgresql&displayType=list) |
| [Code Owners](https://github.com/open-telemetry/opentelemetry-collector-contrib/blob/main/CONTRIBUTING.md#becoming-a-code-owner)    | [@antonblock](https://www.github.com/antonblock), [@ishleenk17](https://www.github.com/ishleenk17), [@Caleb-Hurshman](https://www.github.com/Caleb-Hurshman) \| Seeking more code owners! |
| Emeritus      | [@djaglowski](https://www.github.com/djaglowski) |

[development]: https://github.com/open-telemetry/opentelemetry-collector/blob/main/docs/component-stability.md#development
[beta]: https://github.com/open-telemetry/opentelemetry-collector/blob/main/docs/component-stability.md#beta
[contrib]: https://github.com/open-telemetry/opentelemetry-collector-releases/tree/main/distributions/otelcol-contrib
<!-- end autogenerated section -->

This receiver queries the PostgreSQL [statistics collector](https://www.postgresql.org/docs/13/monitoring-stats.html).

## Prerequisites

See PostgreSQL documentation for [supported versions](https://www.postgresql.org/support/versioning).

The monitoring user must be granted `SELECT` on `pg_stat_database`.

> [!NOTE]
> The feature gate `receiver.postgresql.separateSchemaAttr` addresses an inconsistency in how schema names
> are reported across different metric types. When enabled, schema names are consistently reported in a
> dedicated `postgresql.schema.name` resource attribute.
>
> **Status:** Alpha (disabled by default)
>
> **When disabled (default behavior):**
> - Table metrics: `postgresql.table.name = "schema_name.table_name"` (schema included)
> - Index metrics: `postgresql.table.name = "table_name"` (schema **missing**)
> - Function metrics: Schema reported separately in some cases
>
> **When enabled (recommended for consistency):**
> - All metrics consistently use:
>   - `postgresql.schema.name = "schema_name"`
>   - `postgresql.table.name = "table_name"`
>
> This ensures reliable correlation of metrics when tables with identical names exist across different schemas.
> To enable:
>
> ```bash
> otelcol-contrib --feature-gates=receiver.postgresql.separateSchemaAttr
> ```
>
> See https://github.com/open-telemetry/opentelemetry-collector-contrib/issues/29559 for more details.

## Configuration

The following settings are required to create a database connection:

- `username`
- `password`

The following settings are optional:

- `endpoint` (default = `localhost:5432`): The endpoint of the postgresql server. Whether using TCP or Unix sockets, this value should be `host:port`. If `transport` is set to `unix`, the endpoint will internally be translated from `host:port` to `/host.s.PGSQL.port`
- `transport` (default = `tcp`): The transport protocol being used to connect to postgresql. Available options are `tcp` and `unix`.

- `databases` (default = `[]`): The list of databases for which the receiver will attempt to collect statistics. If an empty list is provided, the receiver will attempt to collect statistics for all non-template databases.

- `exclude_databases` (default = `[]`): List of databases which will be excluded when collecting statistics.

The following settings are also optional and nested under `tls` to help configure client transport security

- `insecure` (default = `false`): Whether to enable client transport security for the postgresql connection.
- `insecure_skip_verify` (default = `true`): Whether to validate server name and certificate if client transport security is enabled.
- `cert_file` (default = `$HOME/.postgresql/postgresql.crt`): A certificate used for client authentication, if necessary.
- `key_file` (default = `$HOME/.postgresql/postgresql.key`): An SSL key used for client authentication, if necessary.
- `ca_file` (default = ""): A set of certificate authorities used to validate the database server's SSL certificate.

- `collection_interval` (default = `10s`): This receiver collects metrics on an interval. This value must be a string readable by Golang's [time.ParseDuration](https://pkg.go.dev/time#ParseDuration). Valid time units are `ns`, `us` (or `Âµs`), `ms`, `s`, `m`, `h`.
- `initial_delay` (default = `1s`): defines how long this receiver waits before starting.

### Query Sample Collection
We provide functionality to collect the query sample from postgresql. It will get historical query 
from `pg_stat_activity`. To enable it, you will need the following configuration
```
...
    events:
      db.server.query_sample:
        enabled: true
...
```
By default, query sample collection is disabled, also note, to use it, you will need 
to grant the user you are using `pg_monitor`. Take the example from `testdata/integration/init.sql`

```sql
GRANT pg_monitor TO otelu;
```

The following options are available:
- `max_rows_per_query`: (optional, default=1000) The max number of rows would return from the query 
against `pg_stat_activity`.

### Top Query Collection
We provide functionality to collect the most executed queries from postgresql. It will get data from `pg_stat_statements` and report incremental value of `total_exec_time`, `total_plan_time`, `calls`, `rows`, `shared_blks_dirtied`, `shared_blks_hit`, `shared_blks_read`, `shared_blks_written`, `temp_blks_read`, `temp_blks_written`. To enable it, you will need the following configuration
```
...
    events:
      db.server.top_query:
        enabled: true
...
```

Along with those attributes, we will also report the query plan we gathered if it is possible. 

By default, top query collection is disabled, also note, to use it, you will need 
to create the extension to every database. Take the example from `testdata/integration/02-create-extension.sh`

```sql
CREATE EXTENSION IF NOT EXISTS pg_stat_statements;
```

The following options are available:
- `max_rows_per_query`: (optional, default=1000) The max number of rows would return from the query 
against `pg_stat_statements`.
- `top_n_query`: (optional, default=200) The maximum number of active queries to report (to the next consumer) in a single run.
- `max_explain_each_interval`: (optional, default=1000). The maximum number of explain query to be sent in each scrape interval. The top query 
collection would not get the query plan directly. Instead, we need to mimic the query in the database and get the query plan from database 
separately. This could lead some resources usage and limit this will reduce the impact on your database.
- `query_plan_cache_size`: (optional, default=1000). The query plan cache size. Once we got explain for one query, we will store it in the cache.
This defines the cache's size for query plan.
- `query_plan_cache_ttl`: (optional, default=1h). How long before the query plan cache got expired. Example values: `1m`, `1h`. 

### Example Configuration

```yaml
receivers:
  postgresql:
    endpoint: localhost:5432
    transport: tcp
    username: otel
    password: ${env:POSTGRESQL_PASSWORD}
    databases:
      - otel
    collection_interval: 10s
    tls:
      insecure: false
      insecure_skip_verify: false
      ca_file: /home/otel/authorities.crt
      cert_file: /home/otel/mypostgrescert.crt
      key_file: /home/otel/mypostgreskey.key
    events:
      db.server.query_sample:
        enabled: true
      db.server.top_query:
        enabled: true
    query_sample_collection:
      max_rows_per_query: 100
    top_query_collection:
      max_rows_per_query: 100
      top_n_query: 100
```

The full list of settings exposed for this receiver are documented in [config.go](./config.go) with detailed sample configurations in [testdata/config.yaml](./testdata/config.yaml). TLS config is documented further under the [opentelemetry collector's configtls package](https://github.com/open-telemetry/opentelemetry-collector/blob/main/config/configtls/README.md).

## Connection pool feature

The feature gate `receiver.postgresql.connectionPool` allows to enable the creation & reuse of a pool per database for the connections instead of creating & closing on each scrape.
This is generally a useful optimization but also alleviates the volume of generated audit logs when the PostgreSQL instance is configured with `log_connections=on` and/or `log_disconnections=on`.

When this feature gate is enabled, the following optional settings are available nested under `connection_pool` to help configure the connection pools:

- `max_idle_time`: The maximum amount of time a connection may be idle before being closed.
- `max_lifetime`: The maximum amount of time a connection may be reused.
- `max_idle`: The maximum number of connections in the idle connection pool.
- `max_open`: The maximum number of open connections to the database.

Those settings and their defaults are further documented in the [`sql/database`](https://pkg.go.dev/database/sql#DB) package.

### Example Configuration

```yaml
receivers:
  postgresql:
    endpoint: localhost:5432
    transport: tcp
    username: otel
    password: ${env:POSTGRESQL_PASSWORD}
    connection_pool:
      max_idle_time: 10m
      max_lifetime: 0
      max_idle: 2
      max_open: 5
```

## Metrics

Details about the metrics produced by this receiver can be found in [metadata.yaml](./metadata.yaml)
