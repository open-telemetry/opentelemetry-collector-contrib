#!/bin/bash
# This script adds the deprecated awscontainerinsightreceiver factory to components.go
# after it has been generated by the builder.

set -e

COMPONENTS_FILE="cmd/otelcontribcol/components.go"

if [ ! -f "$COMPONENTS_FILE" ]; then
    echo "Error: $COMPONENTS_FILE not found"
    exit 1
fi

# Check if the deprecated factory is already added
if grep -q "NewDeprecatedFactory" "$COMPONENTS_FILE"; then
    echo "Deprecated factory already registered in $COMPONENTS_FILE"
    exit 0
fi

# Add the deprecated factory to the receivers list
# Use awk for better cross-platform compatibility
awk '/awscontainerinsightreceiver\.NewFactory\(\),/ { print; print "\t\tawscontainerinsightreceiver.NewDeprecatedFactory(),"; next } 1' "$COMPONENTS_FILE" > "${COMPONENTS_FILE}.tmp" && mv "${COMPONENTS_FILE}.tmp" "$COMPONENTS_FILE"

# Add the deprecated factory to the ReceiverModules map
awk '/factories\.ReceiverModules\[awscontainerinsightreceiver\.NewFactory\(\)\.Type\(\)\] = "github\.com\/open-telemetry\/opentelemetry-collector-contrib\/receiver\/awscontainerinsightreceiver v0\.140\.0"/ { print; print "\tfactories.ReceiverModules[awscontainerinsightreceiver.NewDeprecatedFactory().Type()] = \"github.com/open-telemetry/opentelemetry-collector-contrib/receiver/awscontainerinsightreceiver v0.140.0\""; next } 1' "$COMPONENTS_FILE" > "${COMPONENTS_FILE}.tmp" && mv "${COMPONENTS_FILE}.tmp" "$COMPONENTS_FILE"

echo "Successfully added deprecated factory to $COMPONENTS_FILE"

