# AWS Logs encoding extension

<!-- status autogenerated section -->
| Status        |           |
| ------------- |-----------|
| Stability     | [alpha]  |
| Distributions | [contrib] |
| Issues        | [![Open issues](https://img.shields.io/github/issues-search/open-telemetry/opentelemetry-collector-contrib?query=is%3Aissue%20is%3Aopen%20label%3Aextension%2Fawslogsencoding%20&label=open&color=orange&logo=opentelemetry)](https://github.com/open-telemetry/opentelemetry-collector-contrib/issues?q=is%3Aopen+is%3Aissue+label%3Aextension%2Fawslogsencoding) [![Closed issues](https://img.shields.io/github/issues-search/open-telemetry/opentelemetry-collector-contrib?query=is%3Aissue%20is%3Aclosed%20label%3Aextension%2Fawslogsencoding%20&label=closed&color=blue&logo=opentelemetry)](https://github.com/open-telemetry/opentelemetry-collector-contrib/issues?q=is%3Aclosed+is%3Aissue+label%3Aextension%2Fawslogsencoding) |
| [Code Owners](https://github.com/open-telemetry/opentelemetry-collector-contrib/blob/main/CONTRIBUTING.md#becoming-a-code-owner)    | [@axw](https://www.github.com/axw), [@constanca-m](https://www.github.com/constanca-m) |

[alpha]: https://github.com/open-telemetry/opentelemetry-collector/blob/main/docs/component-stability.md#alpha
[contrib]: https://github.com/open-telemetry/opentelemetry-collector-releases/tree/main/distributions/otelcol-contrib
<!-- end autogenerated section -->

This extension unmarshals logs encoded in formats produced by AWS services, including:
 - [Amazon CloudWatch Logs Subscription Filters](https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/SubscriptionFilters.html).
 - [VPC flow log records](https://docs.aws.amazon.com/vpc/latest/userguide/flow-log-records.html) sent to S3 in plain text.
   - Parquet support still to be added.
 - [S3 access log records](https://docs.aws.amazon.com/AmazonS3/latest/userguide/LogFormat.html).
 - [AWS CloudTrail logs](https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-log-file-examples.html).
- ELB access logs:
   - [Classic Load Balancer (CLB)](https://docs.aws.amazon.com/elasticloadbalancing/latest/classic/access-log-collection.html)
   - [Application Load Balancer (ALB)](https://docs.aws.amazon.com/elasticloadbalancing/latest/application/load-balancer-access-logs.html)
   - [Network Load Balancer (NLB)](https://docs.aws.amazon.com/elasticloadbalancing/latest/network/load-balancer-access-logs.html)
 - (More to be added later.)


Example for Amazon CloudWatch Logs Subscription Filters:
```yaml
extensions:
  awslogs_encoding/cloudwatch:
    format: cloudwatch

receivers:
  awsfirehose:
    endpoint: :1234
    encoding: awslogs_encoding/cloudwatch
```

Example for VPC flow logs:
```yaml
extensions:
  awslogs_encoding/vpcflow:
    format: vpcflow
    vpcflow:
      # options [parquet, plain-text]. 
      # parquet option still needs to be implemented.
      file_format: plain-text 
```

Example for S3 access logs:
```yaml
extensions:
  awslogs_encoding/s3access:
    format: s3access
```

Example for CloudTrail logs:
```yaml
extensions:
  awslogs_encoding/cloudtrail:
    format: cloudtrail
```

Example for ELB access logs:
```yaml
extensions:
  awslogs_encoding/elbaccess:
    format: elbaccess
```

## Log Format Identification

All logs processed by this extension are automatically tagged with an `encoding.format` attribute at the scope level to identify the source format. This allows you to easily filter and route logs based on their AWS service origin.

The pattern used is `aws.<format_name>`.

Examples:
- VPC Flow Logs: `encoding.format:"aws.vpcflow"`
- ELB Access Logs: `encoding.format:"aws.elbaccess"`

## Format Values

The following format values are supported in the `awslogsencodingextension` to identify different AWS log types:

| **AWS Log Type** | **Format Value** | **Description** |
|------------------|------------------|-----------------|
| VPC Flow Logs | `vpcflow` | Virtual Private Cloud flow log records |
| ELB Access Logs | `elbaccess` | Elastic Load Balancer access logs (ALB, NLB, CLB) |
| S3 Access Logs | `s3access` | Amazon S3 server access logs |
| CloudTrail Logs | `cloudtrail` | AWS CloudTrail API call logs |
| WAF Logs | `waf` | AWS Web Application Firewall logs |
| CloudWatch Logs | `cloudwatch` | CloudWatch Logs Subscription Filter events |

### Breaking Change Notice

**Format values have been simplified in v0.137.0**

**The old format values are deprecated and will be unsupported in v0.138.0.**

| **AWS Log Type** | **Old Format Value (Deprecated)** | **New Format Value** |
|------------------|-----------------------------------|---------------------|
| VPC Flow Logs | `vpc_flow_log` | `vpcflow` |
| ELB Access Logs | `elb_access_log` | `elbaccess` |
| S3 Access Logs | `s3_access_log` | `s3access` |
| CloudTrail Logs | `cloudtrail_log` | `cloudtrail` |
| WAF Logs | `waf_log` | `waf` |
| CloudWatch Logs | `cloudwatch_logs_subscription_filter` | `cloudwatch` |

#### Migration Path

If you're using the old format values you should update the encoding extension configuration with the new format values.


## Produced Records per Format

### VPC flow log record fields

[VPC flow log record fields](https://docs.aws.amazon.com/vpc/latest/userguide/flow-log-records.html#flow-logs-fields) are mapped this way in the resulting OpenTelemetry log:

| Flow log field               | Attribute in OpenTelemetry log                                                                        |
|------------------------------|-------------------------------------------------------------------------------------------------------|
| `version`                    | `aws.vpc.flow.log.version`                                                                            |
| `account-id`                 | `cloud.account.id`                                                                                    |
| `interface-id`               | `network.interface.name`                                                                              |
| `srcaddr`                    | `source.address`: if `pkt-srcaddr` not filled or the same <br> `network.peer.address`: otherwise      |
| `pkt-srcaddr`                | `source.address` if filled                                                                            |
| `dstaddr`                    | `destination.address`: if `pkt-dstaddr` not filled or the same <br> `network.peer.address`: otherwise |
| `pkt-dstaddr`                | `destination.address` if filled                                                                       |
| `srcport`                    | `source.port`                                                                                         |
| `dstport`                    | `destination.port`                                                                                    |
| `protocol`                   | `network.protocol.name`                                                                               |
| `packets`                    | `aws.vpc.flow.packets`                                                                                |
| `bytes`                      | `aws.vpc.flow.bytes`                                                                                  |
| `start`                      | `aws.vpc.flow.start`                                                                                  |
| `end`                        | Log timestamp                                                                                         |
| `action`                     | `aws.vpc.flow.action`                                                                                 |
| `log-status`                 | `aws.vpc.flow.status`                                                                                 |
| `vpc-id`                     | `aws.vpc.id`                                                                                          |
| `subnet-id`                  | `aws.vpc.subnet.id`                                                                                   |
| `instance-id`                | `host.id`                                                                                             |
| `tcp-flags`                  | `network.tcp.flags`                                                                                   |
| `type`                       | `network.type`                                                                                        |
| `region`                     | `cloud.region`                                                                                        |
| `az-id`                      | `aws.az.id`                                                                                           |
| `sublocation-type`           | `aws.sublocation.type`                                                                                |
| `sublocation-id`             | `aws.sublocation.id`                                                                                  |
| `pkt-src-aws-service`        | `aws.vpc.flow.source.service`                                                                         |
| `pkt-dst-aws-service`        | `aws.vpc.flow.destination.service`                                                                    |
| `flow-direction`             | `network.io.direction`                                                                                |
| `traffic-path`               | `aws.vpc.flow.traffic_path`                                                                           |
| `ecs-cluster-arn`            | `aws.ecs.cluster.arn`                                                                                 |
| `ecs-cluster-name`           | `aws.ecs.cluster.name`                                                                                |
| `ecs-container-instance-arn` | `aws.ecs.container.instance.arn`                                                                      |
| `ecs-container-instance-id`  | `aws.ecs.container.instance.id`                                                                       |
| `ecs-container-id`           | `aws.ecs.container.id`                                                                                |
| `ecs-second-container-id`    | `aws.ecs.second.container.id`                                                                         |
| `ecs-service-name`           | `aws.ecs.service.name`                                                                                |
| `ecs-task-definition-arn`    | `aws.ecs.task.definition.arn`                                                                         |
| `ecs-task-arn`               | `aws.ecs.task.arn`                                                                                    |
| `ecs-task-id`                | `aws.ecs.task.id`                                                                                     |
| `reject-reason`              | `aws.vpc.flow.reject_reason`                                                                          |

### S3 access log record fields

[S3 access log record fields](https://docs.aws.amazon.com/AmazonS3/latest/userguide/LogFormat.html) are mapped this way in the resulting OpenTelemetry log:


| AWS field           | OpenTelemetry Field                                                                                                                                                                                                                                                                                     |
|---------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Bucket owner        | `aws.s3.owner`                                                                                                                                                                                                                                                                                          |
| Bucket              | `aws.s3.bucket`                                                                                                                                                                                                                                                                                         |
| Time                | Log timestamp                                                                                                                                                                                                                                                                                           |
| Remote IP           | `source.address`                                                                                                                                                                                                                                                                                        |
| Requester           | `user.id`                                                                                                                                                                                                                                                                                               |
| Request ID          | `aws.request_id`                                                                                                                                                                                                                                                                                        |
| Operation           | `rpc.method`                                                                                                                                                                                                                                                                                            |
| Key                 | `aws.s3.key`                                                                                                                                                                                                                                                                                            |
| Request URI         | Split by space: <br> 1. `http.request.method` <br> 2. URL is parsed:<br> &nbsp;&nbsp; 1. `url.path`<br> &nbsp;&nbsp; 2. `url.scheme`<br> &nbsp;&nbsp; 3. `url.query` <br>3. Protocol splits in character `/`:<br> &nbsp;&nbsp; 1.`network.protocol.name`<br> &nbsp;&nbsp; 2. `network.protocol.version` |
| HTTP status         | `http.response.status_code`                                                                                                                                                                                                                                                                             |
| Error code          | `error.type`                                                                                                                                                                                                                                                                                            |
| Bytes sent          | `http.response.body.size`                                                                                                                                                                                                                                                                               |
| Object size         | `aws.s3.object.size`                                                                                                                                                                                                                                                                                    |
| Total time          | `duration`                                                                                                                                                                                                                                                                                              |
| Turn around time    | `aws.s3.turn_around_time`                                                                                                                                                                                                                                                                               |
| Referer             | `http.request.header.referer`                                                                                                                                                                                                                                                                           |
| User-Agent          | `user_agent.original`                                                                                                                                                                                                                                                                                   |
| Version ID          | `aws.s3.version_id`                                                                                                                                                                                                                                                                                     |
| Host ID             | `aws.extended_request_id`                                                                                                                                                                                                                                                                               |
| Signature version   | `aws.signature.version`                                                                                                                                                                                                                                                                                 |
| Cipher suite        | `tls.cipher`                                                                                                                                                                                                                                                                                            |
| Authentication Type | `aws.s3.auth_type`                                                                                                                                                                                                                                                                                      |
| Host header         | `http.request.header.host`                                                                                                                                                                                                                                                                              |
| TLS version         | `tls.protocol.version`                                                                                                                                                                                                                                                                                  |
| Access point ARN    | `aws.s3.access_point.arn`                                                                                                                                                                                                                                                                               |
| aclRequired         | `aws.s3.acl_required`                                                                                                                                                                                                                                                                                   |
### AWS WAF log record fields

[AWS WAF log record fields](https://docs.aws.amazon.com/waf/latest/developerguide/logging-fields.html) are mapped this way in the resulting OpenTelemetry log:



| Original log field            | OpenTelemetry field                                                                              |
|-------------------------------|--------------------------------------------------------------------------------------------------|
| `webaclId`                    | `cloud.resource_id`<br>Also splits the value to get:<br>1.`cloud.region`<br>2.`cloud.account.id` |
| `terminatingRuleId`           | `aws.waf.terminating_rule.id`                                                                    |
| `terminatingRuleType`         | `aws.waf.terminating_rule.type`                                                                  |
| `httpSourceName`              | `aws.waf.source.name`                                                                            |
| `httpSourceId`                | `aws.waf.source.id`                                                                              |
| `httpRequest.clientIp`        | `client.address`                                                                                 |
| `httpRequest.headers`         | Each header is saved under `http.request.header.<header_name>`                                   |
| `httpRequest.uri`             | `url.path`                                                                                       |
| `httpRequest.args`            | `url.query`                                                                                      |
| `httpRequest.httpMethod`      | `http.request.method`                                                                            |
| `httpRequest.httpVersion`     | Splits in:<br>1.`network.protocol.name`<br>2.`network.protocol.version`                          |
| `httpRequest.requestId`       | `aws.request_id`                                                                                 |
| `httpRequest.fragment`        | `url.fragment`                                                                                   |
| `httpRequest.scheme`          | `url.scheme`                                                                                     |
| `httpRequest.country`         | `geo.country.iso_code`                                                                           |
| `httpRequest.host`            | `server.address`                                                                                 |
| `responseCodeSent`            | `http.response.status_code`                                                                      |
| `ja3Fingerprint`              | `tls.client.ja3`                                                                                 |
| `ja4Fingerprint`              | `tls.client.ja4`                                                                                 |
| `formatVersion`               | _Currently not supported_                                                                        |
| `terminatingRuleMatchDetails` | _Currently not supported_                                                                        |
| `ruleGroupList`               | _Currently not supported_                                                                        |
| `rateBasedRuleList`           | _Currently not supported_                                                                        |
| `nonTerminatingMatchingRules` | _Currently not supported_                                                                        |
| `requestHeadersInserted`      | _Currently not supported_                                                                        |
| `labels`                      | _Currently not supported_                                                                        |
| `captchaResponse`             | _Currently not supported_                                                                        |
| `cfDistributionTenantId`      | _Currently not supported_                                                                        |
| `challengeResponse`           | _Currently not supported_                                                                        |
| `oversizeFields`              | _Currently not supported_                                                                        |

### CloudTrail log record fields

[CloudTrail log record fields](https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-event-reference-record-contents.html) are mapped this way in the resulting OpenTelemetry log:

| CloudTrail field                      | Attribute in OpenTelemetry log                                |
|---------------------------------------|---------------------------------------------------------------|
| `eventID`                             | `aws.cloudtrail.event_id`                                     |
| `eventVersion`                        | `aws.cloudtrail.event_version`                                |
| `eventCategory`                       | `aws.event.category`                                          |
| `errorCode`                           | `aws.error.code`                                              |
| `managementEvent`                     | `aws.event.management`                                        |
| `errorMessage`                        | `aws.error.message`                                           |
| `readOnly`                            | `aws.event.read_only`                                         |
| `userIdentity.identityStoreArn`       | `aws.identity_store.arn`                                      |
| `insightDetails`                      | `aws.insight_details` (as a map, if available)                |
| `userIdentity.arn`                    | `aws.principal.arn`                                           |
| `userIdentity.principalId`            | `aws.principal.id`                                            |
| `userIdentity.type`                   | `aws.principal.type`                                          |
| `userIdentity.accessKeyId`            | `aws.access_key.id`                                           |
| `requestParameters`                   | `aws.request.parameters` (map of all request parameters)      |
| `requestID`                           | `aws.request_id`                                              |
| `resources`                           | `aws.resources` (as an array, if available)                   |
| `responseElements`                    | `aws.response.elements` (map of all response elements)        |
| `sessionCredentialFromConsole`        | `aws.session.console` (set to true if value is "true")        |
| `sharedEventID`                       | `aws.shared_event_id`                                         |
| `recipientAccountId`                  | `cloud.account.id`                                            |
| `awsRegion`                           | `cloud.region`                                                |
| `eventName`                           | `rpc.method`                                                  |
| `eventSource`                         | `rpc.service`                                                 |
| `eventType`                           | `rpc.system`                                                  |
| `tlsDetails.clientProvidedHostHeader` | `server.address`                                              |
| `sourceIPAddress`                     | `source.address`                                              |
| `tlsDetails.cipherSuite`              | `tls.cipher`                                                  |
| `tlsDetails.tlsVersion`               | `tls.protocol.version`                                        |
| `userAgent`                           | `user_agent.original`                                         |
| `userIdentity.userId`                 | `user.id`                                                     |
| `userIdentity.userName`               | `user.name`                                                   |

All request parameters and response elements are included directly as nested maps in the attributes, preserving their original structure.

### ELB Access Log Fields

ELB access log record fields are mapped this way in the resulting OpenTelemetry log:

#### Application Load Balancer (ALB)

> AWS Fields are according to [documentation](https://docs.aws.amazon.com/elasticloadbalancing/latest/application/load-balancer-access-logs.html).


| **AWS Field**                | **OpenTelemetry Field(s)**                                           |
|------------------------------|----------------------------------------------------------------------|
| type                         | `network.protocol.name`                                              |
| time                         | Log timestamp                                                        |
| elb                          | `cloud.resource_id`                                                  |
| client:port                  | `client.address`, `client.port`                                      |
| received_bytes               | `http.request.size`                                                  |
| sent_bytes                   | `http.response.size`                                                 |
| "request"                    | `url.full`, `http.request.method`, `network.protocol.version`        |
| ssl_cipher                   | `tls.cipher`                                                         |
| ssl_protocol                 | `tls.protocol.version`                                               |
| elb_status_code              | `aws.elb.status.code`                                                |
| user_agent                   | `user_agent.original`                                                |
| domain_name                  | `url.domain`                                                         |
| target:port                  | _Currently not supported_                                |
| request_processing_time      | _Currently not supported_                                |
| target_processing_time       | _Currently not supported_                                |
| response_processing_time     | _Currently not supported_                                |
| target_status_code           | _Currently not supported_                                |
| target_group_arn             | _Currently not supported_                                |
| "trace_id"                   | _Currently not supported_                                |
| "chosen_cert_arn"            | _Currently not supported_                                |
| matched_rule_priority        | _Currently not supported_                                |
| request_creation_time        | _Currently not supported_                                |
| "actions_executed"           | _Currently not supported_                                |
| "redirect_url"               | _Currently not supported_                                |
| "error_reason"               | _Currently not supported_                                |
| "target:port_list"           | _Currently not supported_                                |
| "target_status_code_list"    | _Currently not supported_                                |
| "classification"             | _Currently not supported_                                |
| "classification_reason"      | _Currently not supported_                                |
| conn_trace_id                | _Currently not supported_                                |

#### Network Load Balancer (NLB)

> AWS Fields are according to [documentation](https://docs.aws.amazon.com/elasticloadbalancing/latest//network/load-balancer-access-logs.html#access-log-entry-format).

| **AWS Field**                | **OpenTelemetry Field(s)**                                  |
|------------------------------|-------------------------------------------------------------|
| type                         | `network.protocol.name`                                     |
| version                      | `network.protocol.version`                                  |
| time                         | Log timestamp                                               |
| elb                          | `cloud.resource_id`                                         |
| listener                     | `aws.elb.tls.listener.resource_id`                          |
| client:port                  | `client.address`, `client.port`                             |
| destination:port             | `destination.address`, `destination.port`                   |
| received_bytes               | `http.request.size`                                         |
| sent_bytes                   | `http.response.size`                                        |
| tls_cipher                   | `tls.cipher`                                                |
| tls_protocol_version         | `tls.protocol.version`                                      |
| domain_name                  | `url.domain`                                                |
| connection_time              | _Currently not supported_                                   |
| tls_handshake_time           | _Currently not supported_                                   |
| incoming_tls_alert           | _Currently not supported_                                   |
| chosen_cert_arn              | _Currently not supported_                                   |
| chosen_cert_serial           | _Currently not supported_                                   |
| tls_named_group              | _Currently not supported_                                   |
| alpn_fe_protocol             | _Currently not supported_                                   |
| alpn_be_protocol             | _Currently not supported_                                   |
| alpn_client_preference_list  | _Currently not supported_                                   |
| tls_connection_creation_time | _Currently not supported_                                   |

#### Classic Load Balancer (CLB)

> AWS Fields are according to [documentation](https://docs.aws.amazon.com/elasticloadbalancing/latest/classic/access-log-collection.html)

| **AWS Field**         | **OpenTelemetry Field(s)**                                                                 |
|-----------------------|--------------------------------------------------------------------------------------------|
| time                  | Log timestamp                                                                              |
| elb                   | `cloud.resource_id`                                                                        |
| client:port           | `client.address`, `client.port`                                                            |
| elb_status_code       | `aws.elb.status.code`                                                                      |
| backend_status_code   | `aws.elb.backend.status.code`                                                              |
| received_bytes        | `http.request.size`                                                                        |
| sent_bytes            | `http.response.size`                                                                       |
| "request"                    | `url.full`, `http.request.method`, `network.protocol.name`, `network.protocol.version`                                    |
| ssl_cipher            | `tls.cipher`                                                                               |
| ssl_protocol          | `tls.protocol.version`                                                                     |
| user_agent            | `user_agent.original`                                                                      |
| backend:port          | _Currently not supported_                                                                  |
| request_processing_time | _Currently not supported_                                                                |
| backend_processing_time | _Currently not supported_                                                                |
| response_processing_time | _Currently not supported_                                                               |
