# External Auth Extension

<!-- status autogenerated section -->
| Status        |           |
| ------------- |-----------|
| Stability     | [alpha]  |
| Distributions | [contrib] |
| Issues        | [![Open issues](https://img.shields.io/github/issues-search/open-telemetry/opentelemetry-collector-contrib?query=is%3Aissue%20is%3Aopen%20label%3Aextension%2Fexternalauth%20&label=open&color=orange&logo=opentelemetry)](https://github.com/open-telemetry/opentelemetry-collector-contrib/issues?q=is%3Aopen+is%3Aissue+label%3Aextension%2Fexternalauth) [![Closed issues](https://img.shields.io/github/issues-search/open-telemetry/opentelemetry-collector-contrib?query=is%3Aissue%20is%3Aclosed%20label%3Aextension%2Fexternalauth%20&label=closed&color=blue&logo=opentelemetry)](https://github.com/open-telemetry/opentelemetry-collector-contrib/issues?q=is%3Aclosed+is%3Aissue+label%3Aextension%2Fexternalauth) |
| Code coverage | [![codecov](https://codecov.io/github/open-telemetry/opentelemetry-collector-contrib/graph/main/badge.svg?component=extension_externalauth)](https://app.codecov.io/gh/open-telemetry/opentelemetry-collector-contrib/tree/main/?components%5B0%5D=extension_externalauth&displayType=list) |
| [Code Owners](https://github.com/open-telemetry/opentelemetry-collector-contrib/blob/main/CONTRIBUTING.md#becoming-a-code-owner)    | [@bogdan-at-adobe](https://www.github.com/bogdan-at-adobe) \| Seeking more code owners! |
| Emeritus      |  |

[alpha]: https://github.com/open-telemetry/opentelemetry-collector/blob/main/docs/component-stability.md#alpha
[contrib]: https://github.com/open-telemetry/opentelemetry-collector-releases/tree/main/distributions/otelcol-contrib
<!-- end autogenerated section -->

This extension implements `configauth.ServerAuthenticator` to authenticate incoming requests using an external authentication service. The authenticator type has to be set to `externalauth`.

The `externalauthextension` is an extension for the OpenTelemetry Collector that allows for external authentication of incoming requests. This extension can be used to integrate with external authentication services to validate credentials and enforce access control policies.

## Problem Statement

In distributed collector architectures where multiple collectors are chained together, authentication failures often go unnoticed until they reach the final collector in the chain. This creates several issues:

- **Silent failures**: Intermediate collectors show successful processing logs while authentication actually fails
- **Debugging complexity**: Authentication issues are only visible at the last collector, making troubleshooting difficult
- **Misleading metrics**: Success metrics from intermediate collectors don't reflect actual authentication status
- **Delayed error detection**: Authentication problems are discovered late in the pipeline

The externalauth extension solves this by performing authentication validation at each collector in the chain, ensuring that authentication failures are detected and logged immediately where they occur.

## Features

- Supports integration with external authentication services
- Validates incoming requests based on external authentication responses
- Enforces access control policies
- Token caching for performance optimization

## Configuration

The following settings are available:

- `endpoint` (required): The URL of the external authentication service
- `header_endpoint_mapping` (optional): Maps header values to different endpoints for dynamic routing
  - Format: `[ { header: "header_name", values: { "header_value": "endpoint_url" } } ]`
  - Falls back to the default `endpoint` if no mapping is found or if not provided
  - **Note**: Only one endpoint mapping will be used per request. If multiple headers in the mapping are present in the request, the first matching header in the array (in the order specified in the configuration) will be used.
- `refresh_interval` (default = "1h"): Specifies the time that a newly checked token will be valid for
- `header` (default = "Authorization"): Specifies the header to use for the token
- `scheme` (default = "Bearer"): Specifies the authentication scheme used for the request
- `expected_codes` (default = [200]): Specifies the list of expected HTTP codes
- `method` (default = "POST"): Specifies the HTTP method to use for the authentication request
- `http_client_timeout` (default = "10s"): Specifies the timeout for the HTTP client when making requests to the external authentication service
- `telemetry_type` (default = "traces"): Specifies the telemetry type for this endpoint. Options: `traces`, `metrics`, `logs`. Only used to be added as a label to metrics
- `token_format` (default = "raw"): Specifies the format of the token. Options: `raw`, `basic_auth`. When `basic_auth` is used, the user label will be added to metrics.

### Example Configuration

```yaml
extensions:
  externalauth:
    endpoint: "https://auth-endpoint"
    telemetry_type: "metrics"  # This endpoint handles metrics

receivers:
  otlp:
    protocols:
      grpc:
        endpoint: "localhost:4317"
        auth:
          authenticator: externalauth

service:
  extensions: [externalauth]
  pipelines:
    traces:
      receivers: [otlp]
      processors: [batch]
      exporters: [otlp]
```

### Advanced Configuration

**Note**: If multiple headers under header_endpoint_mapping match in a request, the first header defined in the configuration takes precedence.

```yaml
extensions:
  externalauth/custom:
    endpoint: "https://custom-auth.example.com"
     header_endpoint_mapping:
      - header: "Destination"
        values:
          stage: "https://stage-auth.example.com"
          prod: "https://prod-auth.example.com"
      - header: "Region"
        values:
          us: "https://us-auth.example.com"
          eu: "https://eu-auth.example.com"
    refresh_interval: "30m"
    header: "X-Custom-Auth"
    expected_codes: [200, 201]
    scheme: "Custom"
    method: "GET"
    http_client_timeout: "5s"
    telemetry_type: "traces"

receivers:
  otlp:
    protocols:
      grpc:
        endpoint: "localhost:4317"
        auth:
          authenticator: externalauth/custom

service:
  extensions: [externalauth/custom]
  pipelines:
    traces:
      receivers: [otlp]
      processors: [batch]
      exporters: [otlp]
```

## Usage

1. Configure the `externalauthextension` in your OpenTelemetry Collector configuration file
2. Start the OpenTelemetry Collector
3. The extension will intercept incoming requests and validate them using the configured external authentication service

The full list of settings exposed for this extension is documented in [config.go](./config.go)
with detailed sample configurations in [testdata/config.yaml](./testdata/config.yaml).
