# Kubernetes Observer

<!-- status autogenerated section -->
| Status        |           |
| ------------- |-----------|
| Stability     | [alpha]  |
| Distributions | [contrib], [k8s] |
| Issues        | [![Open issues](https://img.shields.io/github/issues-search/open-telemetry/opentelemetry-collector-contrib?query=is%3Aissue%20is%3Aopen%20label%3Aextension%2Fk8sobserver%20&label=open&color=orange&logo=opentelemetry)](https://github.com/open-telemetry/opentelemetry-collector-contrib/issues?q=is%3Aopen+is%3Aissue+label%3Aextension%2Fk8sobserver) [![Closed issues](https://img.shields.io/github/issues-search/open-telemetry/opentelemetry-collector-contrib?query=is%3Aissue%20is%3Aclosed%20label%3Aextension%2Fk8sobserver%20&label=closed&color=blue&logo=opentelemetry)](https://github.com/open-telemetry/opentelemetry-collector-contrib/issues?q=is%3Aclosed+is%3Aissue+label%3Aextension%2Fk8sobserver) |
| Code coverage | [![codecov](https://codecov.io/github/open-telemetry/opentelemetry-collector-contrib/graph/main/badge.svg?component=extension_k8s_observer)](https://app.codecov.io/gh/open-telemetry/opentelemetry-collector-contrib/tree/main/?components%5B0%5D=extension_k8s_observer&displayType=list) |
| [Code Owners](https://github.com/open-telemetry/opentelemetry-collector-contrib/blob/main/CONTRIBUTING.md#becoming-a-code-owner)    | [@dmitryax](https://www.github.com/dmitryax), [@ChrsMark](https://www.github.com/ChrsMark) |
| Emeritus      | [@rmfitzpatrick](https://www.github.com/rmfitzpatrick) |

[alpha]: https://github.com/open-telemetry/opentelemetry-collector/blob/main/docs/component-stability.md#alpha
[contrib]: https://github.com/open-telemetry/opentelemetry-collector-releases/tree/main/distributions/otelcol-contrib
[k8s]: https://github.com/open-telemetry/opentelemetry-collector-releases/tree/main/distributions/otelcol-k8s
<!-- end autogenerated section -->

The `k8s_observer` is a [Receiver Creator](../../../receiver/receivercreator/README.md)-compatible "watch observer" that detects and reports Kubernetes pod, port, container, service, ingress, and node endpoints via the Kubernetes API.

## Quick Start: Metrics and Port Discovery

Discover services by port and scrape metrics from dynamically discovered endpoints:

```yaml
extensions:
  k8s_observer:
    auth_type: serviceAccount
    node: ${env:K8S_NODE_NAME}
    observe_pods: true
    observe_nodes: true

receivers:
  receiver_creator:
    watch_observers: [k8s_observer]
    receivers:
      redis:
        rule: type == "port" && pod.name matches "redis"
        config:
          password: '`pod.labels["SECRET"]`'
      kubeletstats:
        rule: type == "k8s.node"
        config:
          auth_type: serviceAccount
          collection_interval: 10s
          endpoint: "`endpoint`:`kubelet_endpoint_port`"
          metric_groups: [container, pod, node]

service:
  extensions: [k8s_observer]
  pipelines:
    metrics:
      receivers: [receiver_creator]
      exporters: [otlp]
```

The `node` field limits discovery to pods on the current node. Set it using the downward API:

```yaml
env:
  - name: K8S_NODE_NAME
    valueFrom:
      fieldRef:
        fieldPath: spec.nodeName
```

## Quick Start: Log Collection

Collect logs from all containers, including init containers and crashed containers:

```yaml
extensions:
  k8s_observer:
    auth_type: serviceAccount
    node: ${env:K8S_NODE_NAME}
    observe_all_containers: true  # Enables init containers and Pending phase

receivers:
  receiver_creator:
    watch_observers: [k8s_observer]
    receivers:
      filelog:
        rule: type == "pod.container"
        config:
          include:
            - /var/log/pods/`pod.namespace`_`pod.name`_`pod.uid`/`container_name`/*.log
          start_at: beginning
          operators:
            - type: container
              id: container-parser

service:
  extensions: [k8s_observer]
  pipelines:
    logs:
      receivers: [receiver_creator]
      exporters: [otlp]
```

The collector pod must mount the node's log directory:

```yaml
volumes:
  - name: varlogpods
    hostPath:
      path: /var/log/pods
volumeMounts:
  - name: varlogpods
    mountPath: /var/log/pods
    readOnly: true
```

## Configuration Reference

All fields are optional.

| Name              | Type      | Default          | Docs |
|-------------------|-----------|------------------| ---- |
| auth_type         | string    | `serviceAccount` | How to authenticate to the K8s API server. One of `none`, `serviceAccount`, or `kubeConfig`. |
| node              | string    |                  | Node name to limit discovery. If unset, discovers endpoints on all nodes. |
| observe_pods      | bool      | `true`           | Whether to report pod and port endpoints. |
| observe_all_containers | bool | `false`          | Convenience option for log collection. When `true`, enables `observe_init_containers` and adds `Pending` to `observe_pod_phases`. Cannot be combined with `observe_pod_phases`. |
| observe_pod_phases | []string | `["Running"]`    | Pod phases to observe. Valid values: `Pending`, `Running`, `Succeeded`, `Failed`, `Unknown`. |
| observe_init_containers | bool | `false`        | Whether to report init container endpoints. |
| container_terminated_ttl | duration | `15m`     | How long terminated containers remain observable. Applies to crashed containers and completed init containers. |
| observe_nodes     | bool      | `false`          | Whether to report k8s.node endpoints. |
| observe_services  | bool      | `false`          | Whether to report k8s.service endpoints. |
| observe_ingresses | bool      | `false`          | Whether to report k8s.ingress endpoints. |
| namespaces        | []string  | `[]`             | Namespaces to observe. Empty means all namespaces. |

## Advanced Topics

### Fine-Grained Container Control

For more control over which containers are observed, use `observe_pod_phases` and `observe_init_containers` instead of `observe_all_containers` (these options are mutually exclusive):

```yaml
extensions:
  k8s_observer:
    observe_pod_phases:
      - Running
      - Pending    # Required to observe running init containers
    observe_init_containers: true
    container_terminated_ttl: 30m  # Custom TTL for terminated containers
```

**Key behaviors:**

- **Init containers** run during the `Pending` phase. Include `Pending` in `observe_pod_phases` to observe them while running.
- **Terminated containers** (both init and regular) are observable for `container_terminated_ttl` after termination. This allows log collection from crashed sidecars and completed init containers.
- **CrashLoopBackOff containers** are automatically observable while waiting to restart, using the `container_terminated_ttl` from their last crash.

Each container endpoint exposes `is_init_container` for filtering in receiver_creator rules:

```yaml
receivers:
  receiver_creator:
    receivers:
      filelog/init:
        rule: type == "pod.container" && is_init_container == true
        config:
          start_at: beginning  # Capture full init container logs
      filelog/app:
        rule: type == "pod.container" && is_init_container == false
        config:
          start_at: end  # Tail application logs
```

### RBAC Permissions

The service account running the collector needs permissions to read the K8s resources it observes.

**ClusterRole for full access:**

```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: otelcontribcol
rules:
- apiGroups: [""]
  resources: [nodes, services, pods]
  verbs: [get, list, watch]
- apiGroups: ["networking.k8s.io"]
  resources: [ingresses]
  verbs: [get, list, watch]
```

**Namespace-scoped access:**

To limit the observer to specific namespaces:

```yaml
extensions:
  k8s_observer:
    namespaces:
      - my-namespace
```

Then use a `Role` and `RoleBinding` instead of `ClusterRole`/`ClusterRoleBinding`. Note that observing nodes still requires cluster-scoped permissions.
