apiVersion: v1
kind: ConfigMap
metadata:
  name: otel-incident-config
  namespace: github-runner
data:
  config.yaml: |
    receivers:
      kubeletstats:
        collection_interval: 60s
        auth_type: "serviceAccount"
        endpoint: "https://${env:K8S_NODE_IP}:10250"
        insecure_skip_verify: true
        metric_groups:
          - pod

    processors:
      groupbyattrs:
        keys:
          - k8s.namespace.name
          - k8s.deployment.name

      filter:
        metrics:
          include:
            match_type: regexp
            metric_names:
              - k8s\.pod\.phase

      resource:
        attributes:
          - key: service.name
            value: github-runner-health
            action: upsert
          - key: alert.severity
            value: critical
            action: upsert

      batch:
        timeout: 60s

    exporters:
      # Using the Hydrolix exporter
      hydrolix:
        endpoint: ${HYDROLIX_ENDPOINT}
        hdx_table: cicd.metrics
        hdx_transform: tf_cicd_metrics_v2
        hdx_username: ${HYDROLIX_USERNAME}
        hdx_password: ${HYDROLIX_PASSWORD}
        timeout: 30s

      # Keep debug exporter for troubleshooting
      debug:
        verbosity: detailed

    service:
      telemetry:
        logs:
          level: info  # Changed to info to see debug logs from exporter
        metrics:
          level: none
      pipelines:
        metrics:
          receivers: [kubeletstats]
          processors: [filter, groupbyattrs, resource, batch]
          exporters: [hydrolix, debug]  # Using hydrolix exporter

---
apiVersion: v1
kind: Secret
metadata:
  name: hydrolix-credentials
  namespace: github-runner
type: Opaque
stringData:
  endpoint: "https://argus.hydrolix.live/ingest/event"
  username: "your-username"
  password: "your-password"

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: runner-incident-monitor
  namespace: github-runner
spec:
  replicas: 1
  selector:
    matchLabels:
      app: runner-incident-monitor
  template:
    metadata:
      labels:
        app: runner-incident-monitor
    spec:
      serviceAccountName: runner-incident-monitor
      hostNetwork: true  # REQUIRED for kubeletstats
      # If using private registry, uncomment:
      # imagePullSecrets:
      #   - name: regcred
      containers:
        - name: otel-collector
          # CHANGE THIS to your custom image
          image: ghcr.io/your-username/otel-collector-hydrolix:latest
          imagePullPolicy: Always  # Use Always during development, IfNotPresent in production
          command:
            - "/otelcol-contrib"
            - "--config=/etc/otel-collector-config/config.yaml"
          resources:
            limits:
              memory: 200Mi  # Increased for custom build
              cpu: 200m
              ephemeral-storage: 8Gi
            requests:
              memory: 100Mi
              cpu: 100m
              ephemeral-storage: 8Gi
          env:
            - name: K8S_NODE_NAME
              valueFrom:
                fieldRef:
                  fieldPath: spec.nodeName
            - name: K8S_NODE_IP
              valueFrom:
                fieldRef:
                  fieldPath: status.hostIP
            - name: HYDROLIX_ENDPOINT
              valueFrom:
                secretKeyRef:
                  name: hydrolix-credentials
                  key: endpoint
            - name: HYDROLIX_USERNAME
              valueFrom:
                secretKeyRef:
                  name: hydrolix-credentials
                  key: username
            - name: HYDROLIX_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: hydrolix-credentials
                  key: password
          volumeMounts:
            - name: otel-collector-config-vol
              mountPath: /etc/otel-collector-config
      volumes:
        - name: otel-collector-config-vol
          configMap:
            name: otel-incident-config

---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: runner-incident-monitor
  namespace: github-runner

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: runner-incident-monitor
rules:
  - apiGroups: [""]
    resources: ["events", "pods", "nodes", "nodes/proxy", "nodes/stats"]
    verbs: ["get", "list", "watch", "create"]
  - apiGroups: ["metrics.k8s.io"]
    resources: ["pods", "nodes"]
    verbs: ["get", "list"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: runner-incident-monitor
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: runner-incident-monitor
subjects:
  - kind: ServiceAccount
    name: runner-incident-monitor
    namespace: github-runner
