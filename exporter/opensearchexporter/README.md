# OpenSearch Exporter

<!-- status autogenerated section -->
| Status        |           |
| ------------- |-----------|
| Stability     | [alpha]: traces, logs   |
| Distributions | [contrib] |
| Issues        | [![Open issues](https://img.shields.io/github/issues-search/open-telemetry/opentelemetry-collector-contrib?query=is%3Aissue%20is%3Aopen%20label%3Aexporter%2Fopensearch%20&label=open&color=orange&logo=opentelemetry)](https://github.com/open-telemetry/opentelemetry-collector-contrib/issues?q=is%3Aopen+is%3Aissue+label%3Aexporter%2Fopensearch) [![Closed issues](https://img.shields.io/github/issues-search/open-telemetry/opentelemetry-collector-contrib?query=is%3Aissue%20is%3Aclosed%20label%3Aexporter%2Fopensearch%20&label=closed&color=blue&logo=opentelemetry)](https://github.com/open-telemetry/opentelemetry-collector-contrib/issues?q=is%3Aclosed+is%3Aissue+label%3Aexporter%2Fopensearch) |
| Code coverage | [![codecov](https://codecov.io/github/open-telemetry/opentelemetry-collector-contrib/graph/main/badge.svg?component=exporter_opensearch)](https://app.codecov.io/gh/open-telemetry/opentelemetry-collector-contrib/tree/main/?components%5B0%5D=exporter_opensearch&displayType=list) |
| [Code Owners](https://github.com/open-telemetry/opentelemetry-collector-contrib/blob/main/CONTRIBUTING.md#becoming-a-code-owner)    | [@ps48](https://www.github.com/ps48) \| Seeking more code owners! |
| Emeritus      | [@Aneurysm9](https://www.github.com/Aneurysm9), [@MitchellGale](https://www.github.com/MitchellGale), [@MaxKsyunz](https://www.github.com/MaxKsyunz), [@YANG-DB](https://www.github.com/YANG-DB) |

[alpha]: https://github.com/open-telemetry/opentelemetry-collector/blob/main/docs/component-stability.md#alpha
[contrib]: https://github.com/open-telemetry/opentelemetry-collector-releases/tree/main/distributions/otelcol-contrib
<!-- end autogenerated section -->

OpenSearch exporter supports sending OpenTelemetry signals as documents to [OpenSearch](https://www.opensearch.org).

The documents are sent using [observability catalog](https://github.com/opensearch-project/opensearch-catalog/tree/main/schema/observability) schema.

## Configuration options

### Indexing Options

The Observability indices would follow the recommended pattern for immutable data stream ingestion using
the [data_stream](https://opensearch.org/docs/latest/dashboards/im-dashboards/datastream) concepts.
Index pattern will follow the next naming template `ss4o_{type}-{dataset}-{namespace}`

- `dataset` (default=`default`) a user-provided label to classify source of telemetry. It is used to construct the name of the destination index or data stream.
- `namespace` (default=`namespace`) a user-provided label to group telemetry. It is used to construct the name of the destination index or data stream.

#### Dynamic Indexing

The OpenSearch exporter supports dynamic index names for both logs and traces using placeholders. You can use any attribute or context key as a placeholder to construct index names dynamically per record.

> Caution: In practice, OpenSearch clusters can become unstable or even break down when index counts reach a very high level. Introducing attributes with high cardinality resulting in many separate indices can significantly impact the stability of your target cluster.

**Configuration Options:**

- `logs_index` - Custom index name pattern for logs
- `logs_index_fallback` - Fallback value when placeholder is missing (default: `unknown`)
- `logs_index_time_format` - Time suffix format for logs
- `traces_index` - Custom index name pattern for traces
- `traces_index_fallback` - Fallback value when placeholder is missing (default: `unknown`)  
- `traces_index_time_format` - Time suffix format for traces

**Placeholder Syntax:**

- Placeholder: `%{key}`
  - Example: `otel-logs-%{service.name}` or `otel-traces-%{custom.label}`
  - The value is looked up from resource attributes, log/span attributes, and scope attributes
  - If the key is missing, the fallback value is used
  - Only one placeholder is supported per index name
  - Generated index names must adhere to [OpenSearch index naming restrictions](https://docs.opensearch.org/docs/latest/api-reference/index-apis/create-index/#index-naming-restrictions)

**Time Suffix Format:**

Both logs and traces support time-formatted suffixes using `*_time_format` options. The time suffix only supports UTC.

- **Valid tokens** (case-sensitive):
  - `yyyy` (4-digit year), `yy` (2-digit year)
  - `MM` (2-digit month), `dd` (2-digit day) 
  - `HH` (2-digit hour, 24h), `mm` (2-digit minute), `ss` (2-digit second)
- **Allowed separators**: `-`, `.`, `_`, `+`
- **Examples:** `yyyy.MM.dd` → `2024.06.07`, `yyyy-MM` → `2024-06`, `yyMMdd` → `240607`

**Default Behavior:**

If custom index names are not set, the exporter uses default patterns:
- Logs: `ss4o_logs-{dataset}-{namespace}`
- Traces: `ss4o_traces-{dataset}-{namespace}`

##### Example Configuration

```yaml
exporters:
  opensearch:
    http:
      endpoint: http://opensearch.example.com:9200
    # Logs configuration
    logs_index: "otel-logs-%{service.name}"
    logs_index_fallback: "default-service"
    logs_index_time_format: "yyyy.MM.dd"
    # Traces configuration  
    traces_index: "otel-traces-%{service.name}"
    traces_index_fallback: "default-service"
    traces_index_time_format: "yyyy.MM.dd"
    sending_queue:
      batch:
```

This configuration will create:
- Log indexes like: `otel-logs-myservice-2024.06.07`
- Trace indexes like: `otel-traces-myservice-2024.06.07`

If `service.name` is missing, the fallback value is used (e.g., `otel-logs-default-service-2024.06.07`).

### OpenSearch document mapping


The mapping mode can be controlled via the scope attribute `opensearch.mapping.mode`. 

The OpenSearch exporter supports several document schemas and preprocessing behaviors, which may be configured through the following settings:

- `mapping`:
  - `mode` (default=`ss4o`): Configures the field mappings. Supported modes are:
    - `ss4o`: Exports logs in the [Simple Schema for Observability](https://opensearch.org/docs/latest/observing-your-data/ss4o/) standard.
    - `ecs`: Maps fields defined in the OpenTelemetry Semantic Conventions to the [Elastic Common Schema](https://www.elastic.co/guide/en/ecs/current/index.html)
    - `flatten_attributes`: Uses the ECS mapping but flattens all resource and log attributes in the record to the top-level.
    - `bodymap`: uses the "body" of a log record as the exact content of the OpenSearch document, without any transformation. This mapping mode is intended for use cases where the client wishes to have complete control over the OpenSearch document structure.
  - `timestamp_field`: (optional) Field to store the timestamp in. If not set, uses the default `@timestamp`.
  - `unix_timestamp`: (optional) Whether to store the timestamp in epoch milliseconds.
  - `dedup`: (optional) removes fields from the document, that have duplicate keys. The filtering only keeps the last value for a key.
  - `dedot`: (optional) convert dotted keys into nested JSON objects.

#### SS4O mapping mode

The default [`Simple Schema for Observability`](https://docs.opensearch.org/latest/observing-your-data/ss4o/) mapping mode.

In `ss4o` mapping mode, the OpenSearch exporter stores documents using the SS4O schema, which is designed for observability data in OpenSearch. Documents use standardized field names and structure to facilitate integration with OpenSearch dashboards and tools.

| Signal    | Supported          |
| --------- | ------------------ |
| Logs      | :white_check_mark: |
| Traces    | :white_check_mark: |

#### ECS mapping mode

> [!WARNING]
> The ECS mapping mode is currently undergoing changes, and its behaviour is unstable.

In `ecs` mapping mode, the OpenSearch exporter maps fields from [OpenTelemetry Semantic Conventions](https://opentelemetry.io/docs/reference/specification/trace/semantic_conventions/) to [Elastic Common Schema (ECS)](https://www.elastic.co/guide/en/ecs/current/index.html) where possible. This mode may be used for compatibility with dashboards and tools that expect ECS.

| Signal    | `ecs`              |
| --------- | ------------------ |
| Logs      | :white_check_mark: |
| Traces    | :no_entry_sign:    |

#### Flatten attributes mapping mode

> [!WARNING]
> The Flatten attributes mapping mode is currently undergoing changes, and its behaviour is unstable.

In `flatten_attributes` mapping mode, the OpenSearch exporter uses the ECS mapping but flattens all resource and log attributes in the record to the top-level of the document.

| Signal    | `flatten_attributes` |
| --------- | -------------------- |
| Logs      | :white_check_mark:   |
| Traces    | :no_entry_sign:      |

#### Bodymap mapping mode

In `bodymap` mapping mode, the OpenSearch exporter supports only logs and uses the "body" of a log record as the exact content of the OpenSearch document, without any transformation. This mapping mode is intended for use cases where the client wishes to have complete control over the OpenSearch document structure.

The bodymap mapping mode only supports log records where the body is of type Map. If the log body is not a Map, encoding will fail with an error. This ensures that only structured map data can be used as the document content in bodymap mode.

| Signal    | `bodymap`           |
| --------- | ------------------- |
| Logs      | :white_check_mark:  |
| Traces    | :no_entry_sign:     |

### HTTP Connection Options

OpenSearch export supports standard [HTTP client settings](https://github.com/open-telemetry/opentelemetry-collector/tree/main/config/confighttp#client-configuration).

- `http.endpoint` (required) `<url>:<port>` of OpenSearch node to send data to.

### TLS settings

Supports standard TLS settings as part of HTTP settings. See [TLS Configuration/Client Settings](https://github.com/open-telemetry/opentelemetry-collector/blob/main/config/configtls/README.md#client-configuration).

### Retry Options

- `retry_on_failure`: See [retry_on_failure](https://github.com/open-telemetry/opentelemetry-collector/blob/main/exporter/exporterhelper/README.md)

### Sending Queue Options

- `sending_queue`: See [sending_queue](https://github.com/open-telemetry/opentelemetry-collector/blob/main/exporter/exporterhelper/README.md)

### Timeout Options

- `timeout` : See [timeout](https://github.com/open-telemetry/opentelemetry-collector/blob/main/exporter/exporterhelper/README.md)

### Bulk Indexer Options

- `bulk_action` (optional): the [action](https://opensearch.org/docs/2.9/api-reference/document-apis/bulk/) for ingesting data. Only `create` and `index` are allowed here.

## Example

```yaml
extensions:
  basicauth/client:
    client_auth:
      username: username
      password: password

exporters:
  opensearch/trace:
    http:
      endpoint: https://opensearch.example.com:9200
      auth:
        authenticator: basicauth/client
    sending_queue:
      batch:
# ······
service:
  pipelines:
    traces:
      receivers: [otlp]
      exporters: [opensearch/trace]
```
