# Agent Upgrades

The Supervisor will download Collector package updates when offered so
by the Backend. The Supervisor will verify the integrity of the packages
and will install them. This requires stopping the Collector, overwriting
the Collector executable file with the newly downloaded version and
starting the Collector. Before overwriting the executable the Supervisor
will save it in case it is necessary for reverting.

## Expected PackagesAvailable Format

The PackagesAvailable message is expected to contain a single 
package. 
* This package MUST have an empty name. 
* The type of the package MUST be top level. 
* The version field SHOULD be the version of the agent with a `v` prefix.
(e.g. `v0.110.0`)
* The download URL MUST point to a gzipped tarball, containing a file named
`otelcol-contrib`. This file will be used as the agent binary.
* The content hash MUST be the sha256 sum of the gzipped tarball.
* The signature field MUST be formatted in the way described
in the [Signature Format](#signature-format) session.

Example:

```go
&protobufs.PackagesAvailable{
    Packages: map[string]*protobufs.PackageAvailable{
        "": {
            Type:    protobufs.PackageType_PackageType_TopLevel,
            Version: "v0.110.0",
            Hash: packageHash
            File: &protobufs.DownloadableFile{
                DownloadUrl: "https://github.com/open-telemetry/opentelemetry-collector-releases/releases/download/v0.111.0/otelcol-contrib_0.111.0_linux_amd64.tar.gz",
                ContentHash: agentSHA256Hash,
                Signature:   signature,
            },
        },
    },
    AllPackagesHash: allPackagesHash,
}
```


## Signing

In order for an agent package to be accepted by the supervisor, the
package MUST be signed. The supervisor expects the agent tarball to be signed
using [Cosign](https://github.com/sigstore/cosign), using the keyless
signing method to generate separate certificate and signature files.

Both the certificate and cosign signature will be used to create the
file's signature in the PackagesAvailable message.

For more information on keyless signing and Cosign, see the
[Cosign docs](https://docs.sigstore.dev/cosign/signing/overview/).

## Signature Format

In the PackagesAvailable message, the signature MUST be created
by joining the base64 encoded certificate and signature files generated 
by Cosign with a space. Note that the files generated by Cosign are already 
base64 encoded and do not need to be encoded further.

The signature format will therefore be like this:
```
${b64_certificate} ${b64_signature}
```

## Signature Verification

The signature is verified using Cosign. In order to verify the signature,
serveral things are needed:
* A set of identities (issuer/subject pairs) that the signature must
signed by.
  * By default, this will be issuer/subject used to sign the agent release
  from the [opentelemetry-collector-releases](https://github.com/open-telemetry/opentelemetry-collector-releases)
  repository.
* (optional) the name of the github repository that generated the artifact.
  * By default, this is "open-telemetry/opentelemetry-collector-releases".
  * This field may be explicitly set empty to skip verifying the repository field
  in the certificate
* A set of [Fulcio](https://github.com/sigstore/fulcio) root certificates
  * These certificates are retrieved from "https://tuf-repo-cdn.sigstore.dev"
  on startup.
* A URL of a running [Rekor](https://github.com/sigstore/rekor) instance.
    * This is hardcoded to be the public Rekor instance, "https://rekor.sigstore.dev".
* A set of trusted Rekor public keys.
  * These public keys are retrieved from "https://tuf-repo-cdn.sigstore.dev"
  on startup.
* A set of trusted certificate transparency (CT) log public keys
  * These certificates are retrieved from "https://tuf-repo-cdn.sigstore.dev"
  on startup.

For a more in depth explanation of how Cosign/Sigstore works, see
[Sigstore's docs](https://docs.sigstore.dev/about/overview/#how-sigstore-works).
