# OpenAPI Processor

<!-- status autogenerated section -->
| Status        |           |
| ------------- |-----------|
| Stability     | [alpha]: traces   |
| Distributions | [contrib] |
| Issues        | [![Open issues](https://img.shields.io/github/issues-search/open-telemetry/opentelemetry-collector-contrib?query=is%3Aissue%20is%3Aopen%20label%3Aprocessor%2Fopenapi%20&label=open&color=orange&logo=opentelemetry)](https://github.com/open-telemetry/opentelemetry-collector-contrib/issues?q=is%3Aopen+is%3Aissue+label%3Aprocessor%2Fopenapi) [![Closed issues](https://img.shields.io/github/issues-search/open-telemetry/opentelemetry-collector-contrib?query=is%3Aissue%20is%3Aclosed%20label%3Aprocessor%2Fopenapi%20&label=closed&color=blue&logo=opentelemetry)](https://github.com/open-telemetry/opentelemetry-collector-contrib/issues?q=is%3Aclosed+is%3Aissue+label%3Aprocessor%2Fopenapi) |

[alpha]: https://github.com/open-telemetry/opentelemetry-collector/blob/main/docs/component-stability.md#alpha
[contrib]: https://github.com/open-telemetry/opentelemetry-collector-releases/tree/main/distributions/otelcol-contrib
<!-- end autogenerated section -->

The OpenAPI processor enriches trace spans by matching URL paths against an OpenAPI specification and adding `url.template` and `peer.service` attributes. This is useful for normalizing high-cardinality URL paths (e.g., `/users/123/orders/456`) into their template form (e.g., `/users/{userId}/orders/{orderId}`).

## Configuration

| Field | Type | Default | Description |
|-------|------|---------|-------------|
| `openapi_file` | string | (required) | Path to the OpenAPI specification file (YAML or JSON), or an HTTP/HTTPS URL |
| `refresh_interval` | duration | `0` | How often to refresh the OpenAPI spec when using an HTTP URL. Set to `0` to disable refresh. |
| `url_attribute` | string | `http.url` | The span attribute containing the URL path to match |
| `url_template_attribute` | string | `url.template` | The attribute name to store the matched URL template |
| `peer_service_attribute` | string | `peer.service` | The attribute name to store the peer service |
| `peer_service` | string | (from OpenAPI info.title) | Value for peer.service. Supports `${info.title}` placeholder |
| `overwrite_existing` | bool | `false` | Whether to overwrite existing attributes |
| `include_query_params` | bool | `false` | Whether to include query parameters in URL matching |
| `use_server_url_matching` | bool | `false` | Enable matching against server URLs from the OpenAPI spec. When enabled, only spans matching a server URL will be processed. |

## How It Works

1. The processor reads the OpenAPI specification file at startup (from file or HTTP URL)
2. It extracts all paths from the spec and converts them to regex patterns
3. If `refresh_interval` is set and using an HTTP URL, the spec is periodically refreshed
4. For each incoming span:
   - It extracts the URL path from the configured attribute
   - Optionally strips query parameters
   - Matches the path against the OpenAPI path patterns
   - If a match is found, it adds the `url.template` and `peer.service` attributes

### Path Matching

OpenAPI path parameters are converted to regex patterns for matching:

| OpenAPI Path | Matches |
|-------------|---------|
| `/users` | `/users` |
| `/users/{userId}` | `/users/123`, `/users/abc` |
| `/users/{userId}/orders/{orderId}` | `/users/123/orders/456` |

## Example Configuration

### Basic Usage (Local File)

```yaml
processors:
  openapi:
    openapi_file: /etc/otel/openapi.yaml
```

### Fetching from HTTP URL with Periodic Refresh

```yaml
processors:
  openapi:
    # Fetch OpenAPI spec from a URL
    openapi_file: https://api.example.com/openapi.yaml
    
    # Refresh the spec every 5 minutes
    refresh_interval: 5m
```

### Full Configuration

```yaml
processors:
  openapi:
    # Path to OpenAPI spec or HTTP URL (required)
    openapi_file: /etc/otel/openapi.yaml
    
    # Refresh interval for HTTP URLs (optional, default: 0 = no refresh)
    refresh_interval: 5m
    
    # Attribute containing the URL to match
    url_attribute: http.url
    
    # Attribute name for the template result
    url_template_attribute: url.template
    
    # Attribute name for peer service
    peer_service_attribute: peer.service
    
    # Custom peer service name (optional)
    # Use ${info.title} to include the API title from the spec
    peer_service: "${info.title}-backend"
    
    # Whether to overwrite existing attributes
    overwrite_existing: false
    
    # Whether to include query parameters in matching
    include_query_params: false
```

### Using with Different URL Attributes

The processor supports multiple URL attribute formats from different semantic conventions:

```yaml
processors:
  # For older semantic conventions
  openapi/old:
    openapi_file: /etc/otel/openapi.yaml
    url_attribute: http.url

  # For newer semantic conventions (v1.21+)
  openapi/new:
    openapi_file: /etc/otel/openapi.yaml
    url_attribute: url.path
    url_template_attribute: http.route
```

## Pipeline Configuration

```yaml
service:
  pipelines:
    traces:
      receivers: [otlp]
      processors: [openapi]
      exporters: [otlp]
```

## Example OpenAPI Specification

```yaml
openapi: "3.0.3"
info:
  title: Pet Store API
  version: "1.0.0"
paths:
  /users:
    get:
      summary: List all users
  /users/{userId}:
    get:
      summary: Get user by ID
  /users/{userId}/orders/{orderId}:
    get:
      summary: Get specific order for user
```

## Input/Output Example

**Input Span Attributes:**
```
http.url: /users/12345/orders/67890
http.method: GET
```

**Output Span Attributes:**
```
http.url: /users/12345/orders/67890
http.method: GET
url.template: /users/{userId}/orders/{orderId}
peer.service: Pet Store API
```

## Fallback Behavior

If the configured `url_attribute` is not found, the processor will attempt to find a URL in these attributes (in order):
1. `http.url`
2. `http.target`
3. `url.path`
4. `url.full`

## Server URL Matching

The processor can use the `servers` field from the OpenAPI spec to identify which traces belong to this service. This is particularly useful when:
- You have multiple OpenAPI specs for different services
- Your traces contain full URLs (e.g., `https://api.example.com/v1/users/123`)
- You want to automatically determine which service a trace belongs to

### How Server URL Matching Works

1. The processor extracts server URLs from the OpenAPI spec's `servers` field
2. Server URLs with variables (e.g., `{version}`) are converted to regex patterns
3. For each incoming span, the full URL is checked against the server URL patterns
4. If a match is found, the server URL prefix is stripped, and the remaining path is matched against the OpenAPI paths

### Server Variables

OpenAPI server variables with enum values are respected:

```yaml
servers:
  - url: https://api.example.com/{version}
    variables:
      version:
        default: v1
        enum: [v1, v2, v3]
```

This will match URLs like:
- `https://api.example.com/v1/users` ✓
- `https://api.example.com/v2/users` ✓
- `https://api.example.com/v3/users` ✓
- `https://api.example.com/v4/users` ✗ (not in enum)

### Example with Server URL Matching

```yaml
processors:
  openapi:
    openapi_file: /etc/otel/openapi.yaml
    use_server_url_matching: true  # Only process traces that match a server URL
```

**Input Span Attributes:**
```
http.url: https://api.example.com/v1/users/12345/orders/67890
http.method: GET
```

**Output Span Attributes:**
```
http.url: https://api.example.com/v1/users/12345/orders/67890
http.method: GET
url.template: /users/{userId}/orders/{orderId}
peer.service: Pet Store API
```

### Multiple OpenAPI Processors

You can use multiple OpenAPI processors with different specs to handle different services:

```yaml
processors:
  openapi/users-api:
    openapi_file: /etc/otel/users-api.yaml
    use_server_url_matching: true
    
  openapi/orders-api:
    openapi_file: /etc/otel/orders-api.yaml
    use_server_url_matching: true

service:
  pipelines:
    traces:
      receivers: [otlp]
      processors: [openapi/users-api, openapi/orders-api]
      exporters: [otlp]
```

## Use Cases

1. **Reducing Cardinality**: Normalize high-cardinality URL paths for better metrics aggregation
2. **Service Identification**: Automatically set `peer.service` based on the API being called
3. **Consistent Routing**: Ensure consistent URL templates across different tracing implementations
