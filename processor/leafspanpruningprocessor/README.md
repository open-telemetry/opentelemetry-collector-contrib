# Leaf Span Pruning Processor

<!-- status autogenerated section -->
| Status                   |           |
| ------------------------ |-----------|
| Stability                | [alpha]: traces   |
| Distributions            | [contrib] |
| Issues                   | [![Open issues](https://img.shields.io/github/issues-search/open-telemetry/opentelemetry-collector-contrib?query=is%3Aissue%20is%3Aopen%20label%3Aprocessor%2Fleafspanpruning%20&label=open&color=orange&logo=opentelemetry)](https://github.com/open-telemetry/opentelemetry-collector-contrib/issues?q=is%3Aopen+is%3Aissue+label%3Aprocessor%2Fleafspanpruning) [![Closed issues](https://img.shields.io/github/issues-search/open-telemetry/opentelemetry-collector-contrib?query=is%3Aissue%20is%3Aclosed%20label%3Aprocessor%2Fleafspanpruning%20&label=closed&color=blue&logo=opentelemetry)](https://github.com/open-telemetry/opentelemetry-collector-contrib/issues?q=is%3Aclosed+is%3Aissue+label%3Aprocessor%2Fleafspanpruning) |
| [Code Owners](https://github.com/open-telemetry/opentelemetry-collector-contrib/blob/main/CODEOWNERS) | [@portertech](https://www.github.com/portertech) |

[alpha]: https://github.com/open-telemetry/opentelemetry-collector/blob/main/docs/component-stability.md#alpha
[contrib]: https://github.com/open-telemetry/opentelemetry-collector-releases/tree/main/distributions/otelcol-contrib
<!-- end autogenerated section -->

## Overview

The Leaf Span Pruning Processor identifies duplicate or similar leaf spans within a single trace, groups them, and replaces each group with a single aggregated summary span.

**Leaf spans** are spans that are not referenced as a parent by any other span in the trace. They typically represent the last actions in an execution call stack (e.g., individual database queries, HTTP calls to external services).

This processor is useful for reducing trace data volume while preserving meaningful information about repeated operations.

## Use Cases

- **Database query optimization**: When an application makes many similar database queries (e.g., N+1 queries), aggregate them into a single summary span
- **Batch operations**: Consolidate many similar leaf operations into a single representative span
- **Cost reduction**: Reduce trace storage costs by eliminating redundant leaf span data

## Configuration

```yaml
processors:
  leafspanpruning:
    # Attributes to use for grouping similar leaf spans (supports glob patterns)
    # Spans with the same name AND same values for matching attributes will be grouped
    # Examples:
    #   - "db.*" matches db.operation, db.name, db.statement, etc.
    #   - "http.request.*" matches http.request.method, http.request.header, etc.
    #   - "db.operation" matches only the exact key "db.operation"
    group_by_attributes:
      - "db.*"
      - "http.method"

    # Minimum number of similar leaf spans required before aggregation
    # Default: 2
    min_spans_to_aggregate: 3

    # Suffix appended to create summary span name
    # Default: "_aggregated"
    summary_span_name_suffix: "_batch"

    # Prefix for aggregation statistics attributes
    # Default: "aggregation."
    aggregation_attribute_prefix: "batch."
```

## Configuration Options

| Field | Type | Default | Description |
|-----|--|---------|-------|
| `group_by_attributes` | []string | [] | Attribute patterns for grouping (supports glob patterns like `db.*`) |
| `min_spans_to_aggregate` | int | 2 | Minimum group size before aggregation occurs |
| `summary_span_name_suffix` | string | "_aggregated" | Suffix appended to summary span names |
| `aggregation_attribute_prefix` | string | "aggregation." | Prefix for aggregation statistics attributes |

### Glob Pattern Support

The `group_by_attributes` field supports glob patterns for matching attribute keys:

| Pattern | Matches |
|-----|--|
| `db.*` | `db.operation`, `db.name`, `db.statement`, etc. |
| `http.request.*` | `http.request.method`, `http.request.header.content-type`, etc. |
| `rpc.*` | `rpc.method`, `rpc.service`, `rpc.system`, etc. |
| `db.operation` | Only the exact key `db.operation` |

When multiple attributes match a pattern, they are all included in the grouping key (sorted alphabetically for consistency).

## Summary Span

When leaf spans are aggregated, the summary span includes:

### Properties
- **Name**: Original span name + configured suffix (e.g., `SELECT_aggregated`)
- **TraceID**: Same as original spans
- **SpanID**: Newly generated unique ID
- **ParentSpanID**: Same as original spans (common parent)
- **StartTimestamp**: Earliest start time of all spans in the group
- **EndTimestamp**: Latest end time of all spans in the group
- **Status**: Error if any span had error; OK if all were OK; Unset otherwise

### Aggregation Attributes
The following attributes are added to the summary span:

| Attribute | Type | Description |
|-----------|------|-------------|
| `aggregation.span_count` | int64 | Number of spans that were aggregated |
| `aggregation.duration_min_ns` | int64 | Minimum duration in nanoseconds |
| `aggregation.duration_max_ns` | int64 | Maximum duration in nanoseconds |
| `aggregation.duration_avg_ns` | int64 | Average duration in nanoseconds |
| `aggregation.duration_total_ns` | int64 | Total duration in nanoseconds |

## Pipeline Placement

This processor is designed to work best when placed after processors that ensure complete traces are available:

```yaml
service:
  pipelines:
    traces:
      receivers: [otlp]
      processors: [groupbytrace, leafspanpruning, batch]
      exporters: [otlp]
```

Or with tail sampling:

```yaml
service:
  pipelines:
    traces:
      receivers: [otlp]
      processors: [tail_sampling, leafspanpruning, batch]
      exporters: [otlp]
```

## Example

### Before Processing

A trace with repeated database queries:
```
root-span (parent)
├── SELECT (leaf) - duration: 10ms, db.operation: select
├── SELECT (leaf) - duration: 15ms, db.operation: select
├── SELECT (leaf) - duration: 12ms, db.operation: select
└── INSERT (leaf) - duration: 20ms, db.operation: insert
```

### After Processing (with `min_spans_to_aggregate: 2`)

```
root-span (parent)
├── SELECT_aggregated (summary)
│   - aggregation.span_count: 3
│   - aggregation.duration_min_ns: 10000000
│   - aggregation.duration_max_ns: 15000000
│   - aggregation.duration_avg_ns: 12333333
│   - aggregation.duration_total_ns: 37000000
└── INSERT (unchanged - only 1 span, below threshold)
```

## Limitations

- Only processes leaf spans (spans with no children)
- Requires complete traces for accurate leaf detection
- Summary span inherits attributes from the first span in the group
