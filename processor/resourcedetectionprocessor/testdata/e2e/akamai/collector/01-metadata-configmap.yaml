apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Name }}-metadata-config
  namespace: default
data:
  server.py: |
    import json
    import os
    import secrets
    from http.server import BaseHTTPRequestHandler, HTTPServer

    # Akamai/Linode instance metadata format
    # Based on https://techdocs.akamai.com/cloud-computing/docs/metadata-service-api
    AKAMAI_INSTANCE_METADATA = {
        "id": 12345678,
        "host_uuid": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
        "label": "test-akamai-instance",
        "region": "us-east",
        "type": "g6-standard-2",
        "tags": ["environment:testing", "team:observability"],
        "specs": {
            "vcpus": 2,
            "memory": 4096,
            "disk": 81920,
            "transfer": 4000,
            "gpus": 0
        },
        "backups": {
            "enabled": True,
            "status": "completed"
        },
        "account_euuid": "ABCD1234-5678-90EF-GHIJ-KLMNOPQRSTUV",
        "image": {
            "id": "linode/ubuntu22.04",
            "label": "Ubuntu 22.04 LTS"
        }
    }

    # Simple token storage (in-memory for testing)
    valid_tokens = set()

    class Handler(BaseHTTPRequestHandler):
        def do_PUT(self):
            # Token endpoint - /v1/token
            if self.path == "/v1/token":
                # Check for required header
                expiry_header = self.headers.get("Metadata-Token-Expiry-Seconds")
                if not expiry_header:
                    self.send_response(400)
                    self.send_header("Content-Type", "text/plain")
                    self.end_headers()
                    self.wfile.write(b"Missing Metadata-Token-Expiry-Seconds header")
                    return

                # Generate a token
                token = secrets.token_hex(32)
                valid_tokens.add(token)

                # go-metadata client expects a JSON array of strings
                body = json.dumps([token]).encode("utf-8")
                self.send_response(200)
                self.send_header("Content-Type", "application/json; charset=utf-8")
                self.send_header("Content-Length", str(len(body)))
                self.end_headers()
                self.wfile.write(body)
                return

            # Not found
            self.send_response(404)
            self.end_headers()

        def do_GET(self):
            # Health check endpoint
            if self.path == "/healthz":
                body = b"ok"
                self.send_response(200)
                self.send_header("Content-Type", "text/plain; charset=utf-8")
                self.send_header("Content-Length", str(len(body)))
                self.end_headers()
                self.wfile.write(body)
                return

            # Instance endpoint - /v1/instance
            if self.path == "/v1/instance":
                # Check for required Metadata-Token header
                token = self.headers.get("Metadata-Token")
                if not token or token not in valid_tokens:
                    self.send_response(401)
                    self.send_header("Content-Type", "text/plain")
                    self.end_headers()
                    self.wfile.write(b"Invalid or missing Metadata-Token")
                    return

                body = json.dumps(AKAMAI_INSTANCE_METADATA).encode("utf-8")
                self.send_response(200)
                self.send_header("Content-Type", "application/json; charset=utf-8")
                self.send_header("Content-Length", str(len(body)))
                self.end_headers()
                self.wfile.write(body)
                return

            # Not found
            self.send_response(404)
            self.end_headers()

        def log_message(self, fmt, *args):
            return

    if __name__ == "__main__":
        port = int(os.environ.get("PORT", "80"))
        server = HTTPServer(("", port), Handler)
        server.serve_forever()
