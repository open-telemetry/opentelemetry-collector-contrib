apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Name }}-metadata-config
  namespace: default
data:
  server.py: |
    import json
    import os
    from http.server import BaseHTTPRequestHandler, HTTPServer
    from urllib.parse import urlparse

    # OpenShift Infrastructure API response format
    # https://docs.openshift.com/container-platform/4.11/rest_api/config_apis/infrastructure-config-openshift-io-v1.html
    OPENSHIFT_INFRASTRUCTURE_RESPONSE = {
        "apiVersion": "config.openshift.io/v1",
        "kind": "Infrastructure",
        "metadata": {
            "name": "cluster"
        },
        "status": {
            "controlPlaneTopology": "HighlyAvailable",
            "infrastructureName": "test-openshift-cluster",
            "infrastructureTopology": "HighlyAvailable",
            "platformStatus": {
                "type": "AWS",
                "aws": {
                    "region": "us-east-1"
                }
            }
        }
    }

    class Handler(BaseHTTPRequestHandler):
        def do_GET(self):
            parsed = urlparse(self.path)
            path = parsed.path

            # Health check endpoint
            if path == "/healthz":
                body = b"ok"
                self.send_response(200)
                self.send_header("Content-Type", "text/plain; charset=utf-8")
                self.send_header("Content-Length", str(len(body)))
                self.end_headers()
                self.wfile.write(body)
                return

            # OpenShift Infrastructure API endpoint
            # The detector calls: /apis/config.openshift.io/v1/infrastructures/cluster/status
            if path == "/apis/config.openshift.io/v1/infrastructures/cluster/status":
                # Check for Authorization header
                auth_header = self.headers.get("Authorization")
                if not auth_header or not auth_header.startswith("Bearer "):
                    self.send_response(401)
                    self.send_header("Content-Type", "text/plain")
                    self.end_headers()
                    self.wfile.write(b"Unauthorized")
                    return

                body = json.dumps(OPENSHIFT_INFRASTRUCTURE_RESPONSE).encode("utf-8")
                self.send_response(200)
                self.send_header("Content-Type", "application/json; charset=utf-8")
                self.send_header("Content-Length", str(len(body)))
                self.end_headers()
                self.wfile.write(body)
                return

            # Not found
            self.send_response(404)
            self.end_headers()

        def log_message(self, fmt, *args):
            return

    if __name__ == "__main__":
        port = int(os.environ.get("PORT", "8443"))
        server = HTTPServer(("", port), Handler)
        server.serve_forever()
