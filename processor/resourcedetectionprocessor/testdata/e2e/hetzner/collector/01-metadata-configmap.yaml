apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Name }}-metadata-config
  namespace: default
data:
  server.py: |
    import os
    from http.server import BaseHTTPRequestHandler, HTTPServer
    from urllib.parse import urlparse

    # Hetzner metadata values
    HETZNER_METADATA = {
        "hostname": "test-hetzner-server",
        "instance-id": "12345678",
        "region": "eu-central",
        "availability-zone": "fsn1-dc14",
        "public-ipv4": "1.2.3.4",
    }

    def build_metadata_yaml():
        lines = []
        for key, value in HETZNER_METADATA.items():
            lines.append(key + ": " + str(value))
        return "\n".join(lines) + "\n"

    class Handler(BaseHTTPRequestHandler):
        def do_GET(self):
            parsed = urlparse(self.path)
            path = parsed.path

            # Health check endpoint
            if path == "/healthz":
                body = b"ok"
                self.send_response(200)
                self.send_header("Content-Type", "text/plain; charset=utf-8")
                self.send_header("Content-Length", str(len(body)))
                self.end_headers()
                self.wfile.write(body)
                return

            # Hetzner full metadata endpoint (YAML format)
            if path == "/hetzner/v1/metadata":
                body = build_metadata_yaml().encode("utf-8")
                self.send_response(200)
                self.send_header("Content-Type", "text/plain; charset=utf-8")
                self.send_header("Content-Length", str(len(body)))
                self.end_headers()
                self.wfile.write(body)
                return

            # Individual metadata endpoints
            for key, value in HETZNER_METADATA.items():
                if path == "/hetzner/v1/metadata/" + key:
                    body = str(value).encode("utf-8")
                    self.send_response(200)
                    self.send_header("Content-Type", "text/plain; charset=utf-8")
                    self.send_header("Content-Length", str(len(body)))
                    self.end_headers()
                    self.wfile.write(body)
                    return

            # Not found
            self.send_response(404)
            self.end_headers()

        def log_message(self, fmt, *args):
            return

    if __name__ == "__main__":
        port = int(os.environ.get("PORT", "80"))
        server = HTTPServer(("", port), Handler)
        server.serve_forever()
