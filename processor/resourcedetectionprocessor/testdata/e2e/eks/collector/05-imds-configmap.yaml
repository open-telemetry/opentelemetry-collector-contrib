apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Name }}-imds-config
  namespace: default
data:
  server.py: |
    import json
    import os
    from http.server import BaseHTTPRequestHandler, HTTPServer

    INSTANCE_DOCUMENT = {
        "accountId": "123456789012",
        "architecture": "x86_64",
        "availabilityZone": "us-west-2a",
        "imageId": "ami-0abc123456789",
        "instanceId": "i-0abc123456789",
        "instanceType": "m5.large",
        "privateIp": "10.0.0.10",
        "region": "us-west-2",
        "version": "2017-09-30",
    }
    HOSTNAME = "ip-10-0-0-10.us-west-2.compute.internal"

    TOKEN_VALUE = "test-token"

    class Handler(BaseHTTPRequestHandler):
        def do_PUT(self):
            if self.path == "/latest/api/token":
                ttl = self.headers.get("X-aws-ec2-metadata-token-ttl-seconds")
                if ttl is None:
                    self.send_response(400)
                    self.end_headers()
                    return
                body = TOKEN_VALUE.encode("utf-8")
                self.send_response(200)
                self.send_header("Content-Type", "text/plain")
                self.send_header("Content-Length", str(len(body)))
                self.end_headers()
                self.wfile.write(body)
                return
            self.send_response(404)
            self.end_headers()

        def do_GET(self):
            # Allow requests with or without metadata token for simplicity
            if self.path == "/healthz":
                body = b"ok"
                self.send_response(200)
                self.send_header("Content-Type", "text/plain; charset=utf-8")
                self.send_header("Content-Length", str(len(body)))
                self.end_headers()
                self.wfile.write(body)
                return

            if self.path == "/latest/dynamic/instance-identity/document":
                body = json.dumps(INSTANCE_DOCUMENT).encode("utf-8")
                self.send_response(200)
                self.send_header("Content-Type", "application/json")
                self.send_header("Content-Length", str(len(body)))
                self.end_headers()
                self.wfile.write(body)
                return

            if self.path == "/latest/meta-data/instance-id":
                body = INSTANCE_DOCUMENT["instanceId"].encode("utf-8")
                self.send_response(200)
                self.send_header("Content-Type", "text/plain")
                self.send_header("Content-Length", str(len(body)))
                self.end_headers()
                self.wfile.write(body)
                return

            if self.path == "/latest/meta-data/hostname":
                body = HOSTNAME.encode("utf-8")
                self.send_response(200)
                self.send_header("Content-Type", "text/plain")
                self.send_header("Content-Length", str(len(body)))
                self.end_headers()
                self.wfile.write(body)
                return

            self.send_response(404)
            self.end_headers()

        def log_message(self, fmt, *args):
            return

    if __name__ == "__main__":
        port = int(os.environ.get("PORT", "8080"))
        httpd = HTTPServer(("", port), Handler)
        httpd.serve_forever()
