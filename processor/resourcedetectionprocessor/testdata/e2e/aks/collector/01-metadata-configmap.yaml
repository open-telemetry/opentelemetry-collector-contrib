apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Name }}-metadata-config
  namespace: default
data:
  server.py: |
    import json
    import os
    from http.server import BaseHTTPRequestHandler, HTTPServer
    from urllib.parse import urlparse, parse_qs

    # Azure IMDS compute metadata format for AKS
    # The resourceGroupName follows the AKS infrastructure resource group format:
    # MC_<resource group>_<cluster name>_<location>
    AZURE_COMPUTE_METADATA = {
        "location": "westus2",
        "name": "aks-nodepool1-12345678-vmss000000",
        "vmId": "f47ac10b-58cc-4372-a567-0e02b2c3d479",
        "vmSize": "Standard_DS2_v2",
        "subscriptionId": "98765432-1234-5678-abcd-123456789012",
        "resourceGroupName": "MC_my-resource-group_my-aks-cluster_westus2",
        "vmScaleSetName": "aks-nodepool1-12345678-vmss",
        "zone": "",
        "osProfile": {
            "computerName": "aks-nodepool1-12345678-vmss000000"
        },
        "tagsList": [
            {"name": "aks-managed-poolName", "value": "nodepool1"},
            {"name": "aks-managed-resourceNameSuffix", "value": "12345678"}
        ]
    }

    class Handler(BaseHTTPRequestHandler):
        def do_GET(self):
            parsed = urlparse(self.path)
            path = parsed.path
            query = parse_qs(parsed.query)

            # Health check endpoint
            if path == "/healthz":
                body = b"ok"
                self.send_response(200)
                self.send_header("Content-Type", "text/plain; charset=utf-8")
                self.send_header("Content-Length", str(len(body)))
                self.end_headers()
                self.wfile.write(body)
                return

            # Azure IMDS compute endpoint
            if path == "/metadata/instance/compute":
                # Check for required Metadata header
                metadata_header = self.headers.get("Metadata")
                if metadata_header != "True":
                    self.send_response(400)
                    self.send_header("Content-Type", "text/plain")
                    self.end_headers()
                    self.wfile.write(b"Missing required Metadata header")
                    return

                # Check for required query parameters
                api_version = query.get("api-version", [None])[0]
                format_param = query.get("format", [None])[0]

                if not api_version:
                    self.send_response(400)
                    self.send_header("Content-Type", "text/plain")
                    self.end_headers()
                    self.wfile.write(b"Missing api-version parameter")
                    return

                body = json.dumps(AZURE_COMPUTE_METADATA).encode("utf-8")
                self.send_response(200)
                self.send_header("Content-Type", "application/json; charset=utf-8")
                self.send_header("Content-Length", str(len(body)))
                self.end_headers()
                self.wfile.write(body)
                return

            # Not found
            self.send_response(404)
            self.end_headers()

        def log_message(self, fmt, *args):
            return

    if __name__ == "__main__":
        port = int(os.environ.get("PORT", "80"))
        server = HTTPServer(("", port), Handler)
        server.serve_forever()
