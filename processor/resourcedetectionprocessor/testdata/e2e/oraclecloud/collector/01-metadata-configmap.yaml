apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Name }}-metadata-config
  namespace: default
data:
  server.py: |
    import json
    import os
    from http.server import BaseHTTPRequestHandler, HTTPServer

    # Oracle Cloud IMDS metadata format
    # See https://docs.oracle.com/en-us/iaas/Content/Compute/Tasks/gettingmetadata.htm
    ORACLECLOUD_METADATA = {
        "id": "ocid1.instance.oc1.phx.exampleuniqueID",
        "displayName": "test-oraclecloud-instance",
        "shape": "VM.Standard.E4.Flex",
        "canonicalRegionName": "us-phoenix-1",
        "availabilityDomain": "uyTH:PHX-AD-1",
        "metadata": {
            "oke-cluster-display-name": "test-oke-cluster"
        }
    }

    class Handler(BaseHTTPRequestHandler):
        def do_HEAD(self):
            # Oracle Cloud IMDS requires Authorization header
            auth = self.headers.get("Authorization", "")
            if auth != "Bearer Oracle":
                self.send_response(401)
                self.end_headers()
                return

            # Health check or instance endpoint probe
            if self.path == "/opc/v2/instance/" or self.path == "/healthz":
                self.send_response(200)
                self.end_headers()
                return

            self.send_response(404)
            self.end_headers()

        def do_GET(self):
            # Health check endpoint (no auth required)
            if self.path == "/healthz":
                body = b"ok"
                self.send_response(200)
                self.send_header("Content-Type", "text/plain; charset=utf-8")
                self.send_header("Content-Length", str(len(body)))
                self.end_headers()
                self.wfile.write(body)
                return

            # Oracle Cloud IMDS requires Authorization header
            auth = self.headers.get("Authorization", "")
            if auth != "Bearer Oracle":
                self.send_response(401)
                self.end_headers()
                return

            # Oracle Cloud IMDS instance metadata endpoint
            if self.path == "/opc/v2/instance/":
                body = json.dumps(ORACLECLOUD_METADATA).encode("utf-8")
                self.send_response(200)
                self.send_header("Content-Type", "application/json; charset=utf-8")
                self.send_header("Content-Length", str(len(body)))
                self.end_headers()
                self.wfile.write(body)
                return

            # Not found
            self.send_response(404)
            self.end_headers()

        def log_message(self, fmt, *args):
            return

    if __name__ == "__main__":
        port = int(os.environ.get("PORT", "80"))
        server = HTTPServer(("", port), Handler)
        server.serve_forever()
