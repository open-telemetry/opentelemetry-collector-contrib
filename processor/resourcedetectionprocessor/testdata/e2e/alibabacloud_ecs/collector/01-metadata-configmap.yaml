apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Name }}-metadata-config
  namespace: default
data:
  server.py: |
    import os
    from http.server import BaseHTTPRequestHandler, HTTPServer
    from urllib.parse import urlparse

    # Token for Alibaba Cloud ECS metadata service (IMDSv2-style)
    VALID_TOKEN = "test-ecs-metadata-token-12345"

    # Alibaba Cloud ECS metadata values
    METADATA = {
        "hostname": "ecs-test-instance.internal",
        "image-id": "m-test123456789",
        "instance-id": "i-test123456789abc",
        "instance/instance-name": "test-ecs-instance",
        "instance/instance-type": "ecs.g6.large",
        "owner-account-id": "1234567890123456",
        "region-id": "cn-hangzhou",
        "zone-id": "cn-hangzhou-a",
    }

    class Handler(BaseHTTPRequestHandler):
        def do_PUT(self):
            parsed = urlparse(self.path)
            path = parsed.path

            # Token endpoint
            if path == "/latest/api/token":
                # Check for TTL header
                ttl_header = self.headers.get("X-aliyun-ecs-metadata-token-ttl-seconds")
                if not ttl_header:
                    self.send_response(400)
                    self.send_header("Content-Type", "text/plain")
                    self.end_headers()
                    self.wfile.write(b"Missing TTL header")
                    return

                body = VALID_TOKEN.encode("utf-8")
                self.send_response(200)
                self.send_header("Content-Type", "text/plain; charset=utf-8")
                self.send_header("Content-Length", str(len(body)))
                self.end_headers()
                self.wfile.write(body)
                return

            # Not found
            self.send_response(404)
            self.end_headers()

        def do_GET(self):
            parsed = urlparse(self.path)
            path = parsed.path

            # Health check endpoint
            if path == "/healthz":
                body = b"ok"
                self.send_response(200)
                self.send_header("Content-Type", "text/plain; charset=utf-8")
                self.send_header("Content-Length", str(len(body)))
                self.end_headers()
                self.wfile.write(body)
                return

            # Metadata endpoints
            if path.startswith("/latest/meta-data/"):
                # Check for token header
                token = self.headers.get("X-aliyun-ecs-metadata-token")
                if token != VALID_TOKEN:
                    self.send_response(401)
                    self.send_header("Content-Type", "text/plain")
                    self.end_headers()
                    self.wfile.write(b"Invalid or missing token")
                    return

                # Extract metadata key from path
                metadata_key = path[len("/latest/meta-data/"):]
                if metadata_key in METADATA:
                    body = METADATA[metadata_key].encode("utf-8")
                    self.send_response(200)
                    self.send_header("Content-Type", "text/plain; charset=utf-8")
                    self.send_header("Content-Length", str(len(body)))
                    self.end_headers()
                    self.wfile.write(body)
                    return

            # Not found
            self.send_response(404)
            self.end_headers()

        def log_message(self, fmt, *args):
            return

    if __name__ == "__main__":
        port = int(os.environ.get("PORT", "80"))
        server = HTTPServer(("", port), Handler)
        server.serve_forever()
