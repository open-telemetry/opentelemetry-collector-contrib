apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Name }}-metadata-config
  namespace: default
data:
  server.py: |
    import json
    import os
    import socket
    from http.server import BaseHTTPRequestHandler, HTTPServer

    # Scaleway Instance Metadata format
    # See https://github.com/scaleway/scaleway-sdk-go/blob/master/api/instance/v1/instance_metadata_sdk.go
    SCALEWAY_METADATA = {
        "id": "11111111-1111-1111-1111-111111111111",
        "name": "test-scaleway-instance",
        "hostname": "test-scaleway-instance",
        "organization": "aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa",
        "project": "bbbbbbbb-bbbb-bbbb-bbbb-bbbbbbbbbbbb",
        "commercial_type": "DEV1-S",
        "arch": "x86_64",
        "state": "running",
        "zone": "fr-par-1",
        "location": {
            "platform_id": "1",
            "hypervisor_id": "1",
            "node_id": "1",
            "cluster_id": "1",
            "zone_id": "fr-par-1"
        },
        "image": {
            "id": "cccccccc-cccc-cccc-cccc-cccccccccccc",
            "name": "Ubuntu 22.04 Jammy Jellyfish",
            "arch": "x86_64"
        },
        "tags": ["otel", "e2e-test"],
        "private_ip": "10.0.0.1",
        "public_ip": {
            "id": "dddddddd-dddd-dddd-dddd-dddddddddddd",
            "address": "51.15.0.1",
            "gateway": "51.15.0.254",
            "netmask": "32",
            "family": "inet",
            "provisioning_mode": "dhcp"
        },
        "ipv6": None,
        "ssh_public_keys": [],
        "volumes": {},
        "timezone": "UTC"
    }

    class Handler(BaseHTTPRequestHandler):
        def do_GET(self):
            # Health check endpoint
            if self.path == "/healthz":
                body = b"ok"
                self.send_response(200)
                self.send_header("Content-Type", "text/plain; charset=utf-8")
                self.send_header("Content-Length", str(len(body)))
                self.end_headers()
                self.wfile.write(body)
                return

            # Scaleway IMDS metadata endpoint
            if self.path == "/conf?format=json" or self.path == "/conf":
                body = json.dumps(SCALEWAY_METADATA).encode("utf-8")
                self.send_response(200)
                self.send_header("Content-Type", "application/json; charset=utf-8")
                self.send_header("Content-Length", str(len(body)))
                self.end_headers()
                self.wfile.write(body)
                return

            # Not found
            self.send_response(404)
            self.end_headers()

        def log_message(self, fmt, *args):
            return

    class DualStackHTTPServer(HTTPServer):
        address_family = socket.AF_INET6

        def server_bind(self):
            # Disable IPV6_V6ONLY to accept both IPv4 and IPv6 connections
            self.socket.setsockopt(socket.IPPROTO_IPV6, socket.IPV6_V6ONLY, 0)
            super().server_bind()

    if __name__ == "__main__":
        port = int(os.environ.get("PORT", "80"))

        # Start dual-stack server (IPv4 + IPv6)
        server = DualStackHTTPServer(("::", port), Handler)
        server.serve_forever()
