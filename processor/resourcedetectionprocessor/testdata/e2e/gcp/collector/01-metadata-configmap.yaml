apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Name }}-metadata-config
  namespace: default
data:
  server.py: |
    import os
    from http.server import BaseHTTPRequestHandler, HTTPServer

    METADATA = {
        "/computeMetadata/v1/project/project-id": "test-project",
        "/computeMetadata/v1/instance/machine-type": "projects/123456789/machineTypes/e2-standard-2",
        "/computeMetadata/v1/instance/id": "9876543210",
        "/computeMetadata/v1/instance/name": "test-instance",
        "/computeMetadata/v1/instance/hostname": "test-instance.c.test-project.internal",
        "/computeMetadata/v1/instance/zone": "projects/123456789/zones/us-central1-b",
        "/computeMetadata/v1/instance/attributes/created-by": "projects/123456789/zones/us-central1-b/instanceGroupManagers/test-mig",
    }

    class Handler(BaseHTTPRequestHandler):
        def do_GET(self):
            if self.path == "/healthz":
                body = b"ok"
                self.send_response(200)
                self.send_header("Content-Type", "text/plain; charset=utf-8")
                self.send_header("Content-Length", str(len(body)))
                self.end_headers()
                self.wfile.write(body)
                return

            if self.headers.get("Metadata-Flavor") != "Google":
                self.send_response(403)
                self.end_headers()
                return

            value = METADATA.get(self.path)
            if value is None:
                self.send_response(404)
                self.end_headers()
                return

            body = value.encode("utf-8")
            self.send_response(200)
            self.send_header("Metadata-Flavor", "Google")
            self.send_header("Content-Type", "text/plain; charset=utf-8")
            self.send_header("Content-Length", str(len(body)))
            self.end_headers()
            self.wfile.write(body)

        def log_message(self, fmt, *args):
            return

    if __name__ == "__main__":
        port = int(os.environ.get("PORT", "8080"))
        server = HTTPServer(("", port), Handler)
        server.serve_forever()
