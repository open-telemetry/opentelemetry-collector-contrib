apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Name }}-metadata-config
  namespace: default
data:
  server.py: |
    import json
    import os
    from http.server import BaseHTTPRequestHandler, HTTPServer
    from urllib.parse import urlparse, parse_qs

    # Azure IMDS compute metadata format
    AZURE_COMPUTE_METADATA = {
        "location": "eastus",
        "name": "test-azure-vm",
        "vmId": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
        "vmSize": "Standard_D2s_v3",
        "subscriptionId": "12345678-1234-1234-1234-123456789abc",
        "resourceGroupName": "test-resource-group",
        "vmScaleSetName": "scaleset-01",
        "zone": "az1",
        "osProfile": {
            "computerName": "test-azure-vm.internal.cloudapp.net"
        },
        "tagsList": [
            {"name": "environment", "value": "testing"},
            {"name": "team", "value": "observability"},
            {"name": "cost-center", "value": "12345"}
        ]
    }

    class Handler(BaseHTTPRequestHandler):
        def do_GET(self):
            parsed = urlparse(self.path)
            path = parsed.path
            query = parse_qs(parsed.query)

            # Health check endpoint
            if path == "/healthz":
                body = b"ok"
                self.send_response(200)
                self.send_header("Content-Type", "text/plain; charset=utf-8")
                self.send_header("Content-Length", str(len(body)))
                self.end_headers()
                self.wfile.write(body)
                return

            # Azure IMDS compute endpoint
            if path == "/metadata/instance/compute":
                # Check for required Metadata header
                metadata_header = self.headers.get("Metadata")
                if metadata_header != "True":
                    self.send_response(400)
                    self.send_header("Content-Type", "text/plain")
                    self.end_headers()
                    self.wfile.write(b"Missing required Metadata header")
                    return

                # Check for required query parameters
                api_version = query.get("api-version", [None])[0]
                format_param = query.get("format", [None])[0]

                if not api_version:
                    self.send_response(400)
                    self.send_header("Content-Type", "text/plain")
                    self.end_headers()
                    self.wfile.write(b"Missing api-version parameter")
                    return

                body = json.dumps(AZURE_COMPUTE_METADATA).encode("utf-8")
                self.send_response(200)
                self.send_header("Content-Type", "application/json; charset=utf-8")
                self.send_header("Content-Length", str(len(body)))
                self.end_headers()
                self.wfile.write(body)
                return

            # Not found
            self.send_response(404)
            self.end_headers()

        def log_message(self, fmt, *args):
            return

    if __name__ == "__main__":
        port = int(os.environ.get("PORT", "80"))
        server = HTTPServer(("", port), Handler)
        server.serve_forever()
